<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Evoly</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exif-js/2.3.0/exif.min.js"></script>

    <style>
        :root {
            /* Logo-Based Colors */
            --logo-light-green: #a2ada3; 
            --logo-light-green-darker: #8c9a8d; 
            --logo-light-green-rgb: 162, 173, 163;

            --logo-dark-slate: #3c4a54;   
            --logo-dark-slate-lighter: #4c5a65; 

            /* Theme Mapping */
            --primary-accent: var(--logo-light-green);
            --primary-accent-darker: var(--logo-light-green-darker);
            --primary-accent-rgb: var(--logo-light-green-rgb);

            --primary-button-bg: var(--logo-dark-slate); 
            --primary-button-text: #FFFFFF;
            --primary-button-hover-bg: var(--logo-dark-slate-lighter);

            --secondary-button-bg: #F0F0F0; 
            --secondary-button-text: #333333;
            --secondary-button-border: #DCDCDC;
            --secondary-button-hover-bg: #E0E0E0;

            --background-main: #FFFFFF; 
            --background-gradient-start: rgba(245, 247, 245, 0.5); 
            --background-gradient-end: rgba(240, 242, 240, 0.3);   
            
            --card-bg: #FFFFFF;
            --card-border: #ECECEC;

            --text-primary: #2c3e50; 
            --text-secondary: #7f8c8d; 
            
            --input-bg: #FFFFFF;
            --input-border: #CED4DA;
            --input-focus-border: var(--primary-accent); 
            --input-focus-shadow-rgb: var(--primary-accent-rgb);

            --danger-color: #D93025; 
            --danger-bg: #FCE8E6;
            --danger-border: #F6C8C4;
            --soft-danger-color: #E57373; 
            --soft-danger-hover-color: #EF5350; 


            --border-radius-main: 10px; 
            --border-radius-small: 6px;
            --box-shadow-main: 0 4px 12px rgba(0,0,0,0.06);
            --box-shadow-light: 0 2px 6px rgba(0,0,0,0.04);
            --transition-speed: 0.2s ease;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            margin: 0;
            background-color: var(--background-main);
            background-image: linear-gradient(135deg, var(--background-gradient-start) 0%, var(--background-gradient-end) 100%);
            color: var(--text-primary);
            line-height: 1.6;
            overscroll-behavior-y: contain;
        }

        .app-container {
            max-width: 700px;
            margin: 0 auto;
            padding: 0;
        }

        .view {
            padding: 25px; 
            min-height: calc(100vh - 50px); 
            box-sizing: border-box;
        }

        h1, h2 {
            color: var(--text-primary);
            margin-top: 0;
            font-weight: 600;
        }
        h1 { font-size: 2.1em; margin-bottom: 0.8em; }
        h2 { font-size: 1.7em; margin-bottom: 0.6em; }
        h3 { font-size: 1.25em; color: var(--text-primary); margin: 0 0 8px 0; font-weight: 500; }


        button, input[type="submit"] {
            background-color: var(--primary-button-bg);
            color: var(--primary-button-text);
            border: none;
            padding: 12px 22px; 
            border-radius: var(--border-radius-main);
            cursor: pointer;
            font-size: 1em;
            font-weight: 500;
            transition: background-color var(--transition-speed), transform var(--transition-speed);
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        button:hover, input[type="submit"]:hover {
            background-color: var(--primary-button-hover-bg);
            transform: translateY(-1px);
        }
        button:active, input[type="submit"]:active {
            transform: translateY(0px);
        }

        button.secondary {
            background-color: var(--secondary-button-bg);
            color: var(--secondary-button-text);
            border: 1px solid var(--secondary-button-border);
            box-shadow: none;
        }
        button.secondary:hover {
            background-color: var(--secondary-button-hover-bg);
        }

        button.danger {
            background-color: var(--danger-color); 
            color: var(--primary-button-text);
        }
        button.danger:hover {
            background-color: #C0271B; 
        }

        .icon-button {
            background: none;
            border: none;
            padding: 8px; 
            cursor: pointer;
            border-radius: 50%; 
            display: inline-flex;
            align-items: center;
            justify-content: center;
            transition: background-color var(--transition-speed), color var(--transition-speed);
            line-height: 1; 
        }
        .icon-button svg {
            width: 20px; 
            height: 20px;
        }

        .icon-button.danger-icon { 
            color: var(--soft-danger-color);
        }
        .icon-button.danger-icon:hover {
            background-color: rgba(229, 115, 115, 0.1); 
            color: var(--soft-danger-hover-color);
        }


        input[type="text"], input[type="email"], input[type="tel"], input[type="password"], input[type="date"], textarea {
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            border: 1px solid var(--input-border);
            border-radius: var(--border-radius-small); 
            font-size: 1em;
            box-sizing: border-box;
            background-color: var(--input-bg);
            color: var(--text-primary);
            transition: border-color var(--transition-speed), box-shadow var(--transition-speed);
        }
        input[type="text"]:focus, input[type="email"]:focus, input[type="tel"]:focus, input[type="password"]:focus, input[type="date"]:focus, textarea:focus {
            outline: none;
            border-color: var(--input-focus-border);
            box-shadow: 0 0 0 3px rgba(var(--input-focus-shadow-rgb), 0.15);
        }
        ::placeholder {
            color: var(--text-secondary);
            opacity: 0.8;
        }
        textarea {
            min-height: 120px;
            resize: vertical;
        }

        .form-group { margin-bottom: 18px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-secondary); font-size: 0.9em;}

        .card {
            background-color: var(--card-bg);
            border-radius: var(--border-radius-main);
            margin-bottom: 0; 
            box-shadow: var(--box-shadow-main);
            transition: transform var(--transition-speed), box-shadow var(--transition-speed);
            border: 1px solid var(--card-border);
        }
        .card.collection-card { 
             cursor: pointer;
             padding: 20px; 
        }
        .card.collection-card:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 6px 16px rgba(0,0,0,0.08);
        }


        .fab { 
            position: fixed; bottom: 30px; right: 30px;
            width: 56px; height: 56px; border-radius: 50%;
            background-color: var(--primary-button-bg); color: var(--primary-button-text);
            font-size: 24px; display: flex; align-items: center; justify-content: center;
            box-shadow: 0 6px 12px rgba(0,0,0,0.15); cursor: pointer; z-index: 1000;
            transition: background-color var(--transition-speed), transform var(--transition-speed);
        }
        .fab:hover { 
            background-color: var(--primary-button-hover-bg); 
            transform: scale(1.05);
        }

        #login-view, #signup-view { 
            display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center;
        }
        #new-collection-modal-view { 
             display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center;
        }

        #login-view form, #signup-view form, #new-collection-modal-view form {
            width: 100%; max-width: 420px; 
            background-color: var(--card-bg);
            padding: 35px; 
            border-radius: var(--border-radius-main); 
            box-shadow: var(--box-shadow-main);
            border: 1px solid var(--card-border);
        }
        
        .auth-logo {
            max-width: 220px; 
            height: auto;
            margin-bottom: 20px;
        }

        #login-view p, #signup-view p { 
            text-align: center;
            color: var(--text-secondary);
            margin-bottom: 30px;
            margin-top: 5px; 
        }

        .header-app-icon {
            width: 36px; 
            height: 36px;
            margin-right: 12px; 
            flex-shrink: 0; 
        }

        /* General Header Styling */
        .view > header {
            display: flex;
            align-items: flex-start; 
            margin-bottom: 25px;
            flex-wrap: wrap; 
        }
        /* Specific for Home View Header */
        #home-view > header {
            justify-content: flex-start; 
        }
         #home-view > header #greeting { 
            margin-top: 0; 
            line-height: 36px; 
            margin-bottom: 0; 
        }
        #home-view > header .header-actions {
            margin-left: auto; 
            align-self: center; 
        }

        /* Headers with Back Button */
        #collection-timeline-view > header,
        #new-entry-view > header,
        #entry-detail-view > header,
        #edit-entry-view > header,
        #tagged-entries-view > header {
            justify-content: flex-start; 
        }

        #collection-timeline-view > header h2,
        #tagged-entries-view > header h2,
        #new-entry-view > header h2,
        #entry-detail-view > header h2, 
        #edit-entry-view > header h2 {
            margin-left: 15px; 
            margin-right: 15px; 
            flex-grow: 1; 
            margin-top: 0; 
            margin-bottom: 0; 
            line-height: 36px; 
        }
        #collection-timeline-view > header .header-actions {
             margin-left: auto;
             align-self: center; 
        }


        /* Grid Container Styling */
        #entries-timeline-container,
        #tagged-entries-container {
            display: grid;
            gap: 15px; 
            grid-template-columns: repeat(2, 1fr); 
        }

        @media (min-width: 480px) { 
            #entries-timeline-container,
            #tagged-entries-container {
                grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            }
        }
        
        .collection-card h3 { margin-bottom: 8px; font-size: 1.3em;}
        .collection-card p { font-size: 0.9em; color: var(--text-secondary); margin: 0;}

        /* New Grid Entry Tile Styling */
        .grid-entry-tile { 
            display: flex;
            flex-direction: column;
            overflow: hidden; 
            cursor: pointer;
        }

        .grid-entry-tile:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 18px rgba(0,0,0,0.1);
        }

        .grid-entry-image {
            width: 100%;
            height: 160px; 
            object-fit: cover;
            display: block; 
        }

        .grid-entry-info {
            padding: 10px;
            display: flex;
            flex-direction: column;
            flex-grow: 1; 
        }
        
        .grid-entry-info .days-since-badge { 
            font-size: 0.7em; 
            padding: 2px 5px; 
            margin-bottom: 6px; 
            align-self: flex-start; 
        }

        .grid-entry-title { 
            font-size: 1.05em; 
            font-weight: 600;
            margin: 0 0 8px 0; 
            color: var(--text-primary);
            line-height: 1.3;
            word-break: break-word; 
        }
        
        /* .grid-entry-info .tag-chips {
            margin-top: auto; 
        } */
        
        .tag-chips { display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 0px; } 
        .tag-chip {
            background-color: var(--secondary-button-bg); 
            color: var(--secondary-button-text);
            padding: 4px 10px; 
            border-radius: 15px; 
            font-size: 0.8em;
            border: 1px solid var(--secondary-button-border);
        }
        .clickable-tag { 
            cursor: pointer;
            transition: background-color var(--transition-speed), color var(--transition-speed), border-color var(--transition-speed);
        }
        .clickable-tag:hover {
            background-color: var(--primary-accent) !important; 
            color: var(--primary-button-text) !important; 
            border-color: var(--primary-accent) !important;
        }
        .days-since-badge { 
            font-size: 0.8em; 
            color: var(--primary-accent); 
            font-weight: 500; 
            background-color: rgba(var(--primary-accent-rgb), 0.15); 
            padding: 3px 6px;
            border-radius: var(--border-radius-small);
            display: inline-block;
        }

        #new-entry-view #image-upload-label {
            display: block; width: 100%; height: 200px;
            border: 2px dashed var(--input-border); 
            border-radius: var(--border-radius-main);
            display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer;
            margin-bottom: 20px; 
            background-color: #F8F9FA; 
            text-align: center; color: var(--text-secondary);
            transition: border-color var(--transition-speed), background-color var(--transition-speed);
        }
        #new-entry-view #image-upload-label:hover { 
            border-color: var(--primary-accent); 
            background-color: #FDFBFF; 
        }
        #new-entry-view #image-upload-label svg {
            color: var(--primary-accent); 
            margin-bottom: 10px;
            width: 52px; height: 52px;
        }
        
        #new-entry-view #image-preview-wrapper { margin-bottom: 20px; text-align: center; }
        #new-entry-view #image-preview-container { position: relative; display: inline-block; max-width: 100%; }
        #new-entry-view #image-preview {
            max-width: 100%; max-height: 300px;
            border-radius: var(--border-radius-main); display: block;
            border: 1px solid var(--card-border);
        }
        #new-entry-view #remove-image-btn {
            position: absolute; top: 8px; right: 8px;
            background: rgba(217, 48, 37, 0.85); 
            color: white;
            border: 1px solid rgba(255,255,255,0.3); 
            border-radius: 50%;
            width: 30px; height: 30px; font-size: 20px; cursor: pointer;
            line-height: 28px; text-align: center; padding:0;
            display: flex; align-items: center; justify-content: center;
        }

        #date-prompt-message { 
            font-size: 0.9em; 
            color: var(--text-secondary); 
            margin-top: -10px; margin-bottom: 10px; 
        }
        #tag-bar, #edit-tag-bar {
            display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 15px;
            padding: 12px; 
            border: 1px solid var(--input-border);
            border-radius: var(--border-radius-small); 
            background-color: var(--input-bg);
        }
        .suggested-tag {
            padding: 6px 12px; 
            border-radius: 18px;
            background-color: var(--secondary-button-bg);
            color: var(--secondary-button-text);
            cursor: pointer; 
            transition: background-color var(--transition-speed), color var(--transition-speed), border-color var(--transition-speed);
            border: 1px solid var(--secondary-button-border);
            font-size: 0.9em;
        }
        .suggested-tag:hover {
            background-color: var(--secondary-button-hover-bg);
            border-color: #C0C0C0;
        }
        .suggested-tag.selected { 
            background-color: var(--primary-accent); 
            color: var(--primary-button-text); 
            border-color: var(--primary-accent-darker);
        }
        #custom-tag-input, #edit-custom-tag-input { 
            flex-grow: 1; 
            border: none; 
            padding: 6px; 
            min-width: 100px; 
            background-color: transparent; 
            color: var(--text-primary);
            font-size: 0.9em;
        }
        #custom-tag-input:focus, #edit-custom-tag-input:focus {
            outline: none;
        }


        #entry-detail-view #detail-image-container {
            width: 100%; height: 40vh; 
            background-color: #F8F9FA; 
            display: flex; align-items: center; justify-content: center; margin-bottom: 25px;
            border-radius: var(--border-radius-main);
            overflow: hidden;
        }
        #entry-detail-view #detail-image { max-width: 100%; max-height: 100%; object-fit: contain; }
        #entry-detail-view #detail-content { padding: 0 10px; }
        #entry-detail-view #detail-content h2 { 
            margin-top: 0; 
            font-size: 1.8em; 
            margin-bottom: 15px;
        }
        #entry-detail-view #detail-notes {
            color: var(--text-secondary);
            line-height: 1.7;
            margin-bottom: 20px;
            font-size: 1em;
        }
        #entry-detail-view #detail-tags .tag-chip { 
            font-size: 0.9em; 
        }
        #entry-detail-view #detail-metadata { 
            font-size: 0.9em; 
            color: var(--text-secondary); 
            margin-top: 15px; 
        }
        .detail-nav { display: flex; justify-content: space-between; margin-top: 25px; gap: 10px; }
        .detail-nav button {
            flex-grow: 1;
        }
        .detail-nav button#edit-entry-btn { 
            background-color: var(--primary-button-bg); 
            color: var(--primary-button-text);
        }
        .detail-nav button#edit-entry-btn:hover {
            background-color: var(--primary-button-hover-bg);
        }
        #delete-entry-btn { margin-top: 20px; display: block; width: 100%; }
        
        .loader {
            border: 4px solid var(--secondary-button-bg); 
            border-top: 4px solid var(--primary-accent); 
            border-radius: 50%; width: 30px; height: 30px;
            animation: spin 1s linear infinite; margin: 20px auto;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .hidden { display: none !important; }
        .text-center { text-align: center; }
        .my-2 { margin-top: 1rem; margin-bottom: 1rem; }
        
        .back-button {
            background-color: var(--secondary-button-bg); 
            border: 1px solid var(--secondary-button-border); 
            color: var(--primary-accent); 
            font-size: 0.9em; 
            cursor: pointer;
            padding: 8px 16px; 
            margin-right: 0; 
            font-weight: 500;
            border-radius: var(--border-radius-main); 
            transition: color var(--transition-speed), background-color var(--transition-speed), border-color var(--transition-speed);
            text-decoration: none; 
            display: inline-flex; 
            align-items: center;
            height: 36px; 
            box-sizing: border-box;
        }
        .back-button:hover {
            background-color: var(--primary-button-hover-bg); 
            color: var(--primary-button-text); 
            border-color: var(--primary-button-hover-bg); 
        }
        
        .error-message {
            color: var(--danger-color);
            font-size: 0.9em;
            margin-top: -5px;
            margin-bottom: 15px;
            background-color: var(--danger-bg);
            padding: 10px;
            border-radius: var(--border-radius-small);
            border: 1px solid var(--danger-border);
            text-align: left;
        }
        
        .switch-link {
            color: var(--primary-accent); 
            cursor: pointer;
            text-decoration: underline;
            margin-top: 20px;
            display: inline-block;
            font-size: 0.9em;
            transition: color var(--transition-speed);
        }
        .switch-link:hover {
            color: var(--primary-accent-darker);
        }

        #edit-entry-view #edit-image-preview {
            max-width: 100%; 
            max-height: 300px; 
            border-radius: var(--border-radius-main); 
            margin-bottom: 20px;
            display: block;
            margin-left: auto;
            margin-right: auto;
            border: 1px solid var(--card-border);
        }
    </style>
</head>
<body>
    <div id="app-container">
        <!-- Login View -->
        <div id="login-view" class="view hidden">
            <form id="login-form">
                <img src="https://wgjxmpahcfhzgflcnlib.supabase.co/storage/v1/object/public/entry-images/Icon/evoly%20icon.png" alt="Evoly Logo" class="auth-logo">
                <p>Track your journeys, one photo at a time.</p>
                <div class="form-group">
                    <label for="login-email">Email</label>
                    <input type="email" id="login-email" required>
                </div>
                <div class="form-group">
                    <label for="login-password">Password</label>
                    <input type="password" id="login-password" required>
                </div>
                <button type="submit">Sign In</button>
                <div id="login-error" class="error-message hidden"></div>
                <span class="switch-link" id="switch-to-signup">Don't have an account? Sign up</span>
            </form>
        </div>

        <!-- Signup View -->
        <div id="signup-view" class="view">
            <form id="signup-form">
                <img src="https://wgjxmpahcfhzgflcnlib.supabase.co/storage/v1/object/public/entry-images/Icon/evoly%20icon.png" alt="Evoly Logo" class="auth-logo">
                <p>Track your journeys, one photo at a time.</p>
                <div class="form-group">
                    <label for="username">Username</label>
                    <input type="text" id="username" required>
                </div>
                <div class="form-group">
                    <label for="phone">Phone (Optional)</label>
                    <input type="tel" id="phone">
                </div>
                <div class="form-group">
                    <label for="email">Email</label>
                    <input type="email" id="email" required>
                </div>
                <div class="form-group">
                    <label for="password">Password</label>
                    <input type="password" id="password" required>
                </div>
                <button type="submit">Sign Up</button>
                <div id="signup-error" class="error-message hidden"></div>
                <span class="switch-link" id="switch-to-login">Already have an account? Sign in</span>
            </form>
        </div>

        <!-- Home View -->
        <div id="home-view" class="view hidden">
            <header>
                <img src="https://wgjxmpahcfhzgflcnlib.supabase.co/storage/v1/object/public/entry-images/Icon/evoly%20icon%20small.png" alt="Evoly Small Icon" class="header-app-icon">
                <h1 id="greeting">Welcome!</h1>
                <div class="header-actions">
                    <button id="new-collection-btn-home">New Collection</button>
                    <button id="sign-out-btn" class="secondary">Sign Out</button>
                </div>
            </header>
            <div id="collections-container">
            </div>
            <p id="no-collections-message" class="text-center my-2 hidden">No collections yet. Start your first one!</p>
            <div id="collections-loading" class="loader hidden"></div>
        </div>

        <!-- New Collection Modal/View -->
        <div id="new-collection-modal-view" class="view hidden">
            <form id="new-collection-form">
                <h2>New Collection</h2>
                <div class="form-group">
                    <label for="collection-name">Collection Name</label>
                    <input type="text" id="collection-name" required>
                </div>
                <button type="submit">Create Collection</button>
                <button type="button" class="secondary" id="cancel-new-collection-btn" style="margin-top: 10px;">Cancel</button>
            </form>
        </div>
        
        <!-- Collection Timeline View -->
        <div id="collection-timeline-view" class="view hidden">
            <header>
                <img src="https://wgjxmpahcfhzgflcnlib.supabase.co/storage/v1/object/public/entry-images/Icon/evoly%20icon%20small.png" alt="Evoly Small Icon" class="header-app-icon">
                <button class="back-button" id="back-to-home-btn">< Home</button>
                <h2 id="collection-title-timeline">Collection Timeline</h2>
                <div class="header-actions">
                    <button id="delete-collection-btn" class="icon-button danger-icon" title="Delete Collection">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-trash3" viewBox="0 0 16 16">
                            <path d="M6.5 1h3a.5.5 0 0 1 .5.5v1H6v-1a.5.5 0 0 1 .5-.5M11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3A1.5 1.5 0 0 0 5 1.5v1H1.5a.5.5 0 0 0 0 1h.538l.853 10.66A2 2 0 0 0 4.885 16h6.23a2 2 0 0 0 1.994-1.84l.853-10.66h.538a.5.5 0 0 0 0-1zm-1 .722L9.78 14H6.22L5.5 3.222zM7.5 5.5a.5.5 0 0 1 .5.5v7a.5.5 0 0 1-1 0v-7a.5.5 0 0 1 .5-.5m3 0a.5.5 0 0 1 .5.5v7a.5.5 0 0 1-1 0v-7a.5.5 0 0 1 .5-.5"/>
                        </svg>
                    </button>
                </div>
            </header>
            <div id="entries-timeline-container"> 
            </div>
            <p id="no-entries-message" class="text-center my-2 hidden">No entries yet. Add your first one!</p>
            <div id="entries-loading" class="loader hidden"></div>
            <button id="add-entry-fab" class="fab">+</button>
        </div>

        <!-- New Entry View -->
        <div id="new-entry-view" class="view hidden">
            <header>
                 <img src="https://wgjxmpahcfhzgflcnlib.supabase.co/storage/v1/object/public/entry-images/Icon/evoly%20icon%20small.png" alt="Evoly Small Icon" class="header-app-icon">
                 <button class="back-button" id="back-to-timeline-btn">< Cancel</button>
                 <h2 id="new-entry-title-header">New Entry</h2>
            </header>
            <form id="new-entry-form">
                <input type="file" id="image-upload" accept="image/*" class="hidden">
                <label for="image-upload" id="image-upload-label">
                    <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" fill="currentColor" class="bi bi-camera" viewBox="0 0 16 16">
                        <path d="M15 12a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1V6a1 1 0 0 1 1-1h1.172a3 3 0 0 0 2.12-.879l.83-.828A1 1 0 0 1 6.827 3h2.344a1 1 0 0 1 .707.293l.828.828A3 3 0 0 0 12.828 5H14a1 1 0 0 1 1 1v6zM2 4a2 2 0 0 0-2 2v6a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2h-1.172a2 2 0 0 1-1.414-.586l-.828-.828A2 2 0 0 0 9.172 2H6.828a2 2 0 0 0-1.414.586l-.828.828A2 2 0 0 1 3.172 4H2z"/>
                        <path d="M8 11a2.5 2.5 0 1 1 0-5 2.5 2.5 0 0 1 0 5zm0 1a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7zM3 6.5a.5.5 0 1 1-1 0 .5.5 0 0 1 1 0z"/>
                    </svg>
                    <p>Tap to select or snap a photo</p>
                </label>
                
                <div id="image-preview-wrapper" class="hidden">
                    <div id="image-preview-container">
                        <img id="image-preview" alt="Image preview">
                        <button type="button" id="remove-image-btn" title="Remove image">×</button>
                    </div>
                </div>
                <div id="image-processing-loader" class="loader hidden"></div>

                <div class="form-group">
                    <label for="entry-date">Date</label>
                    <input type="date" id="entry-date" required>
                    <p id="date-prompt-message" class="hidden">Please set the date manually.</p>
                </div>
                <div class="form-group">
                    <label for="entry-title">Title</label>
                    <input type="text" id="entry-title" required>
                </div>
                <div class="form-group">
                    <label for="entry-notes">Notes/Observations</label>
                    <textarea id="entry-notes"></textarea>
                </div>
                <div class="form-group">
                    <label>Tags (AI suggestions, click to toggle, or type your own)</label>
                    <div id="tag-bar">
                        <input type="text" id="custom-tag-input" placeholder="Add custom tag...">
                    </div>
                    <button type="button" id="add-custom-tag-btn" class="secondary" style="margin-top:5px; font-size:0.9em;">Add Tag</button>
                </div>
                <button type="submit" id="create-entry-btn">Create Entry</button>
                <div id="entry-upload-loader" class="loader hidden"></div>
            </form>
        </div>

        <!-- Entry Detail View -->
        <div id="entry-detail-view" class="view hidden">
            <header>
                <img src="https://wgjxmpahcfhzgflcnlib.supabase.co/storage/v1/object/public/entry-images/Icon/evoly%20icon%20small.png" alt="Evoly Small Icon" class="header-app-icon">
                <button class="back-button" id="back-to-timeline-from-detail-btn">< Back to Timeline</button>
            </header>
            <div id="detail-image-container">
                <img id="detail-image" alt="Entry image">
            </div>
            <div id="detail-content">
                <h2 id="detail-title">Entry Title</h2>
                <p id="detail-notes">Full narrative here...</p>
                <div id="detail-tags" class="tag-chips"></div>
                <p id="detail-metadata">Date: YYYY-MM-DD</p>
                <div class="detail-nav">
                    <button id="prev-entry-btn" class="secondary">Previous</button>
                    <button id="edit-entry-btn">Edit</button>
                    <button id="next-entry-btn" class="secondary">Next</button>
                </div>
                <button id="delete-entry-btn" class="danger">Delete This Entry</button>
            </div>
        </div>
        
        <!-- Edit Entry View -->
        <div id="edit-entry-view" class="view hidden">
            <header>
                <img src="https://wgjxmpahcfhzgflcnlib.supabase.co/storage/v1/object/public/entry-images/Icon/evoly%20icon%20small.png" alt="Evoly Small Icon" class="header-app-icon">
                <button class="back-button" id="back-to-detail-btn">< Cancel</button>
                <h2 id="edit-entry-title-header">Edit Entry</h2>
            </header>
            <form id="edit-entry-form">
                <div id="edit-image-preview-wrapper">
                    <img id="edit-image-preview" alt="Entry image">
                </div>
                
                <div class="form-group">
                    <label for="edit-entry-date">Date</label>
                    <input type="date" id="edit-entry-date" required>
                </div>
                <div class="form-group">
                    <label for="edit-entry-title">Title</label>
                    <input type="text" id="edit-entry-title" required>
                </div>
                <div class="form-group">
                    <label for="edit-entry-notes">Notes/Observations</label>
                    <textarea id="edit-entry-notes"></textarea>
                </div>
                <div class="form-group">
                    <label>Tags (click to toggle, or type your own)</label>
                    <div id="edit-tag-bar">
                        <input type="text" id="edit-custom-tag-input" placeholder="Add custom tag...">
                    </div>
                    <button type="button" id="edit-add-custom-tag-btn" class="secondary" style="margin-top:5px; font-size:0.9em;">Add Tag</button>
                </div>
                <button type="submit" id="save-entry-btn">Save Changes</button>
                <div id="edit-upload-loader" class="loader hidden"></div>
            </form>
        </div>

        <!-- Tagged Entries View -->
        <div id="tagged-entries-view" class="view hidden">
            <header>
                <img src="https://wgjxmpahcfhzgflcnlib.supabase.co/storage/v1/object/public/entry-images/Icon/evoly%20icon%20small.png" alt="Evoly Small Icon" class="header-app-icon">
                <button class="back-button" id="back-from-tagged-view-btn">< Back</button>
                <h2 id="tagged-entries-title">Entries Tagged: ...</h2>
            </header>
            <div id="tagged-entries-container"> 
            </div>
            <p id="no-tagged-entries-message" class="text-center my-2 hidden">No entries found with this tag.</p>
            <div id="tagged-entries-loading" class="loader hidden"></div>
        </div>

    </div>

    <script>
        // Configuration - Replace these with your values
        const SUPABASE_URL = 'https://wgjxmpahcfhzgflcnlib.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndnanhtcGFoY2ZoemdmbGNubGliIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDcyMzQzNjAsImV4cCI6MjA2MjgxMDM2MH0.6ji6OY6-g8IkdVvR6f9iZAN83qJunCN4EjnVey8_LJc';
        const GOOGLE_CLOUD_VISION_API_KEY = 'AIzaSyDB9lq0UssbbXndJrwVL-TEaplkbPOmk4w'; // Your actual key
        
        // Initialize Supabase
        const { createClient } = supabase;
        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // App State
        const appState = {
            currentUser: null,
            collections: [],
            currentView: 'signup', 
            activeCollectionId: null,
            activeEntryId: null,
            activeEntries: [], 
            selectedImageFile: null,
            selectedImageDataURL: null,
            currentTags: [],      
            aiSuggestedTags: [],  
            currentTagName: null, 
            taggedEntries: [],    
            viewBeforeTagSearch: null, 
            entryIdBeforeTagSearch: null, 
            collectionIdForEntryBeforeTagSearch: null, 
        };

        // View Elements
        const views = {
            signup: document.getElementById('signup-view'),
            login: document.getElementById('login-view'),
            home: document.getElementById('home-view'),
            newCollectionModal: document.getElementById('new-collection-modal-view'),
            collectionTimeline: document.getElementById('collection-timeline-view'),
            newEntry: document.getElementById('new-entry-view'),
            entryDetail: document.getElementById('entry-detail-view'),
            editEntry: document.getElementById('edit-entry-view'),
            taggedEntries: document.getElementById('tagged-entries-view'),
        };

        // Form Elements
        const loginForm = document.getElementById('login-form');
        const signupForm = document.getElementById('signup-form');
        const newCollectionForm = document.getElementById('new-collection-form');
        const newEntryForm = document.getElementById('new-entry-form');
        const editEntryForm = document.getElementById('edit-entry-form');
        
        // Get all other elements
        const greetingEl = document.getElementById('greeting');
        const collectionsContainer = document.getElementById('collections-container');
        const noCollectionsMessage = document.getElementById('no-collections-message');
        const collectionsLoading = document.getElementById('collections-loading');
        const collectionTitleTimeline = document.getElementById('collection-title-timeline');
        const entriesTimelineContainer = document.getElementById('entries-timeline-container');
        const noEntriesMessage = document.getElementById('no-entries-message');
        const entriesLoading = document.getElementById('entries-loading');
        const imageUploadInput = document.getElementById('image-upload');
        const imageUploadLabel = document.getElementById('image-upload-label');
        const imagePreviewWrapper = document.getElementById('image-preview-wrapper');
        const imagePreview = document.getElementById('image-preview');
        const imageProcessingLoader = document.getElementById('image-processing-loader');
        const entryDateInput = document.getElementById('entry-date');
        const datePromptMessage = document.getElementById('date-prompt-message');
        const tagBar = document.getElementById('tag-bar'); 
        const editTagBarEl = document.getElementById('edit-tag-bar'); 
        const entryUploadLoader = document.getElementById('entry-upload-loader');
        const detailImage = document.getElementById('detail-image');
        const detailTitle = document.getElementById('detail-title');
        const detailNotes = document.getElementById('detail-notes');
        const detailTagsContainer = document.getElementById('detail-tags');
        const detailMetadata = document.getElementById('detail-metadata');
        const loginError = document.getElementById('login-error');
        const signupError = document.getElementById('signup-error');

        // Navigation function
        function navigateTo(viewId) {
            appState.currentView = viewId;
            Object.keys(views).forEach(id => {
                views[id].classList.add('hidden');
            });
            if (views[viewId]) {
                views[viewId].classList.remove('hidden');
            }
            window.scrollTo(0, 0);
        }

        // Utility functions
        function formatDate(dateStrOrObj) {
            const date = new Date(dateStrOrObj);
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function daysBetween(d1Str, d2Str) {
            if (!d1Str || !d2Str) return null;
            const d1 = new Date(d1Str);
            const d2 = new Date(d2Str);
            if (isNaN(d1) || isNaN(d2)) return null;
            const laterDate = Math.max(d1.getTime(), d2.getTime());
            const earlierDate = Math.min(d1.getTime(), d2.getTime());
            return Math.ceil((laterDate - earlierDate) / (1000 * 60 * 60 * 24));
        }

        // Supabase Auth Functions
        async function checkAuth() {
            try {
                const { data: { user } } = await supabaseClient.auth.getUser();
                if (user) {
                    appState.currentUser = user;
                    const { data: profile } = await supabaseClient
                        .from('profiles')
                        .select('*')
                        .eq('id', user.id)
                        .single();
                    
                    if (profile) {
                        appState.currentUser.username = profile.username;
                        appState.currentUser.phone = profile.phone;
                    }
                    
                    await loadCollections();
                    renderHomeView();
                    navigateTo('home');
                } else {
                    navigateTo('signup'); 
                }
            } catch (error) {
                console.error('Auth check error:', error);
                navigateTo('signup'); 
            }
        }

        // Database Functions
        async function loadCollections() {
            collectionsLoading.classList.remove('hidden');
            try {
                const { data: collections, error } = await supabaseClient
                    .from('collections')
                    .select('*')
                    .eq('user_id', appState.currentUser.id) 
                    .order('created_at', { ascending: false });

                if (error) throw error;
                appState.collections = collections || [];
                
                for (const collection of appState.collections) {
                    const { count } = await supabaseClient
                        .from('entries')
                        .select('*', { count: 'exact', head: true })
                        .eq('collection_id', collection.id);
                    collection.entryCount = count || 0;
                    
                    const { data: lastEntry } = await supabaseClient
                        .from('entries')
                        .select('date')
                        .eq('collection_id', collection.id)
                        .order('date', { ascending: false })
                        .limit(1)
                        .single();
                    collection.lastEntryDate = lastEntry?.date;
                }
            } catch (error) {
                console.error('Error loading collections:', error);
            } finally {
                collectionsLoading.classList.add('hidden');
            }
        }

        async function loadEntries(collectionId) {
            entriesLoading.classList.remove('hidden');
            try {
                const { data: entries, error } = await supabaseClient
                    .from('entries')
                    .select('*')
                    .eq('collection_id', collectionId)
                    .order('date', { ascending: false }); // Newest first

                if (error) throw error;
                return entries || [];
            } catch (error) {
                console.error('Error loading entries:', error);
                return [];
            } finally {
                entriesLoading.classList.add('hidden');
            }
        }

        async function uploadImage(file, userId) {
            const fileExt = file.name.split('.').pop();
            const fileName = `${userId}/${Date.now()}.${fileExt}`; 
            
            const { data, error } = await supabaseClient.storage
                .from('entry-images')
                .upload(fileName, file, { contentType: file.type, upsert: false });

            if (error) { console.error('Upload error:', error); throw error; }
            
            const { data: { publicUrl } } = supabaseClient.storage
                .from('entry-images')
                .getPublicUrl(fileName);
            return publicUrl;
        }

        async function predictTagsForImage(imgDataURL) {
            if (!GOOGLE_CLOUD_VISION_API_KEY || GOOGLE_CLOUD_VISION_API_KEY === 'YOUR_GOOGLE_CLOUD_VISION_API_KEY_HERE') {
                console.warn("Google Cloud Vision API key not configured or is a generic placeholder. Skipping tag prediction.");
                return [];
            }
            imageProcessingLoader.classList.remove('hidden');
            try {
                const base64Content = imgDataURL.split(',')[1];
                const response = await fetch(`https://vision.googleapis.com/v1/images:annotate?key=${GOOGLE_CLOUD_VISION_API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        requests: [{
                            image: { content: base64Content },
                            features: [
                                { type: 'LABEL_DETECTION', maxResults: 7 },
                                { type: 'OBJECT_LOCALIZATION', maxResults: 3 }
                            ]
                        }]
                    })
                });
                const result = await response.json();
                if (!response.ok || result.error || !result.responses || !result.responses[0]) {
                    console.error('Vision API error:', result.error || 'Invalid response');
                    return [];
                }
                const labels = result.responses[0].labelAnnotations || [];
                const objects = result.responses[0].localizedObjectAnnotations || [];
                const allPotentialTags = [...labels.map(l => l.description), ...objects.map(o => o.name)];
                const processedTags = allPotentialTags.map(tag => {
                    const lowercaseTag = tag.toLowerCase();
                    if (lowercaseTag.includes('dog') || lowercaseTag.includes('puppy')) return 'Dog';
                    if (lowercaseTag.includes('cat') || lowercaseTag.includes('kitten')) return 'Cat';
                    if (lowercaseTag.includes('flower') || lowercaseTag.includes('blossom')) return 'Flowering';
                    if (lowercaseTag.includes('plant') || lowercaseTag.includes('flora')) return 'Plant';
                    return tag.charAt(0).toUpperCase() + tag.slice(1).toLowerCase();
                });
                return [...new Set(processedTags)].filter(Boolean).slice(0, 5);
            } catch (e) {
                console.error("Prediction error:", e);
                return [];
            } finally {
                imageProcessingLoader.classList.add('hidden');
            }
        }

        // Render Functions
        function renderHomeView() {
            if (!appState.currentUser) { navigateTo('signup'); return; }
            greetingEl.textContent = `Welcome, ${appState.currentUser.username || appState.currentUser.email.split('@')[0]}!`;
            collectionsContainer.innerHTML = '';
            noCollectionsMessage.classList.toggle('hidden', appState.collections.length > 0);
            appState.collections.forEach(col => {
                const card = document.createElement('div');
                card.className = 'card collection-card';
                card.dataset.id = col.id;
                card.innerHTML = `
                    <h3>${col.name}</h3>
                    <p>${col.entryCount || 0} entries. ${col.lastEntryDate ? `Last: ${formatDate(col.lastEntryDate)}` : 'No entries yet'}</p>
                `;
                card.onclick = () => {
                    appState.activeCollectionId = col.id;
                    renderCollectionTimelineView();
                };
                collectionsContainer.appendChild(card);
            });
        }

        async function renderCollectionTimelineView() {
            const collection = appState.collections.find(c => c.id === appState.activeCollectionId);
            if (!collection) { console.error("Collection not found"); navigateTo('home'); return; }
            collectionTitleTimeline.textContent = collection.name;
            entriesTimelineContainer.innerHTML = '';
            appState.activeEntries = await loadEntries(collection.id); // Newest first
            noEntriesMessage.classList.toggle('hidden', appState.activeEntries.length > 0);
            
            appState.activeEntries.forEach((entry, idx) => {
                const tile = document.createElement('div');
                tile.className = 'card grid-entry-tile'; 
                tile.dataset.id = entry.id;
                
                let badgeHTML = '';
                if (idx < appState.activeEntries.length - 1) {
                    const currentDate = new Date(entry.date); 
                    const olderEntryDate = new Date(appState.activeEntries[idx + 1].date); 
                    
                    if (currentDate.getTime() > olderEntryDate.getTime()) {
                        const daysDiff = daysBetween(entry.date, appState.activeEntries[idx + 1].date);
                        if (daysDiff > 0) {
                            badgeHTML = `<span class="days-since-badge">${daysDiff} day${daysDiff > 1 ? 's' : ''} later</span>`;
                        }
                    } else if (currentDate.getTime() === olderEntryDate.getTime()) { 
                        badgeHTML = `<span class="days-since-badge">Same day</span>`;
                    }
                }
                
                tile.innerHTML = `
                    <img src="${entry.image_url}" alt="${entry.title}" class="grid-entry-image">
                    <div class="grid-entry-info">
                        ${badgeHTML}
                        <h3 class="grid-entry-title">${entry.title}</h3>
                        <!-- Tags removed from grid view -->
                    </div>`;
                tile.onclick = () => {
                    appState.activeEntryId = entry.id;
                    renderEntryDetailView(entry); 
                    navigateTo('entryDetail');
                };
                entriesTimelineContainer.appendChild(tile); 
            });
            navigateTo('collectionTimeline');
        }
        
        // --- Tag Bar UI for New/Edit Entry ---
        function _renderTagBar(barElement, inputId, selectedTags, suggestedTags, addCustomFn, removeSelectedFn, selectSuggestedFn) {
            const customInputEl = barElement.querySelector(`#${inputId}`);
            const customVal = customInputEl ? customInputEl.value : '';
            barElement.innerHTML = '';

            selectedTags.forEach(tag => {
                const chip = document.createElement('span');
                chip.className = 'suggested-tag selected';
                chip.textContent = tag;
                chip.dataset.tag = tag;
                chip.onclick = () => removeSelectedFn(tag);
                barElement.appendChild(chip);
            });

            suggestedTags.forEach(tag => {
                if (!selectedTags.includes(tag)) { 
                    const chip = document.createElement('span');
                    chip.className = 'suggested-tag';
                    chip.textContent = tag;
                    chip.dataset.tag = tag;
                    chip.onclick = () => selectSuggestedFn(tag);
                    barElement.appendChild(chip);
                }
            });
            
            const newCustomInput = document.createElement('input');
            newCustomInput.type = 'text';
            newCustomInput.id = inputId;
            newCustomInput.placeholder = 'Add custom tag...';
            newCustomInput.value = customVal;
            barElement.appendChild(newCustomInput);
        }

        // Handlers for New Entry Tag Bar
        function handleAddCustomTagForNewEntry() {
            const input = tagBar.querySelector('#custom-tag-input');
            const tag = input.value.trim();
            if (tag && !appState.currentTags.includes(tag)) {
                appState.currentTags.push(tag);
                appState.aiSuggestedTags = appState.aiSuggestedTags.filter(st => st !== tag);
            }
            input.value = '';
            _renderTagBar(tagBar, 'custom-tag-input', appState.currentTags, appState.aiSuggestedTags, handleAddCustomTagForNewEntry, handleRemoveSelectedTagForNewEntry, handleSelectSuggestedTagForNewEntry);
        }
        function handleRemoveSelectedTagForNewEntry(tagToRemove) {
            appState.currentTags = appState.currentTags.filter(t => t !== tagToRemove);
            _renderTagBar(tagBar, 'custom-tag-input', appState.currentTags, appState.aiSuggestedTags, handleAddCustomTagForNewEntry, handleRemoveSelectedTagForNewEntry, handleSelectSuggestedTagForNewEntry);
        }
        function handleSelectSuggestedTagForNewEntry(tagToSelect) {
            if (!appState.currentTags.includes(tagToSelect)) {
                appState.currentTags.push(tagToSelect);
            }
            appState.aiSuggestedTags = appState.aiSuggestedTags.filter(t => t !== tagToSelect);
            _renderTagBar(tagBar, 'custom-tag-input', appState.currentTags, appState.aiSuggestedTags, handleAddCustomTagForNewEntry, handleRemoveSelectedTagForNewEntry, handleSelectSuggestedTagForNewEntry);
        }

        // Handlers for Edit Entry Tag Bar
        function handleAddCustomTagForEditEntry() {
            const input = editTagBarEl.querySelector('#edit-custom-tag-input');
            const tag = input.value.trim();
            if (tag && !appState.currentTags.includes(tag)) {
                appState.currentTags.push(tag);
            }
            input.value = '';
            _renderTagBar(editTagBarEl, 'edit-custom-tag-input', appState.currentTags, [], handleAddCustomTagForEditEntry, handleRemoveSelectedTagForEditEntry, () => {});
        }
        function handleRemoveSelectedTagForEditEntry(tagToRemove) {
            appState.currentTags = appState.currentTags.filter(t => t !== tagToRemove);
            _renderTagBar(editTagBarEl, 'edit-custom-tag-input', appState.currentTags, [], handleAddCustomTagForEditEntry, handleRemoveSelectedTagForEditEntry, () => {});
        }


        function renderNewEntryForm() {
            newEntryForm.reset();
            imagePreviewWrapper.classList.add('hidden');
            imageUploadLabel.classList.remove('hidden');
            imagePreview.src = '#';
            datePromptMessage.classList.add('hidden');
            entryDateInput.value = formatDate(new Date());
            appState.selectedImageFile = null;
            appState.selectedImageDataURL = null;
            appState.currentTags = []; 
            appState.aiSuggestedTags = []; 
            _renderTagBar(tagBar, 'custom-tag-input', appState.currentTags, appState.aiSuggestedTags, handleAddCustomTagForNewEntry, handleRemoveSelectedTagForNewEntry, handleSelectSuggestedTagForNewEntry);
            imageProcessingLoader.classList.add('hidden');
            entryUploadLoader.classList.add('hidden');
        }
        
        function renderEditEntryForm(entry) {
            document.getElementById('edit-image-preview').src = entry.image_url;
            document.getElementById('edit-entry-date').value = formatDate(entry.date);
            document.getElementById('edit-entry-title').value = entry.title;
            document.getElementById('edit-entry-notes').value = entry.notes || '';
            appState.currentTags = [...(entry.tags || [])];
            _renderTagBar(editTagBarEl, 'edit-custom-tag-input', appState.currentTags, [], handleAddCustomTagForEditEntry, handleRemoveSelectedTagForEditEntry, () => {});
            document.getElementById('edit-upload-loader').classList.add('hidden');
        }


        function renderEntryDetailView(entry) {
            detailImage.src = entry.image_url;
            detailTitle.textContent = entry.title;
            detailNotes.textContent = entry.notes || 'No notes.';
            detailMetadata.textContent = `Date: ${formatDate(entry.date)}`;
            
            detailTagsContainer.innerHTML = ''; 
            (entry.tags || []).forEach(tag => {
                const tagChip = document.createElement('span');
                tagChip.className = 'tag-chip clickable-tag';
                tagChip.textContent = tag;
                tagChip.dataset.tag = tag;
                tagChip.onclick = () => handleTagClick(tag);
                detailTagsContainer.appendChild(tagChip);
            });
            
            const idx = appState.activeEntries.findIndex(e => e.id === appState.activeEntryId);
            document.getElementById('prev-entry-btn').disabled = idx === 0;
            document.getElementById('next-entry-btn').disabled = idx === appState.activeEntries.length - 1;
            document.getElementById('prev-entry-btn').onclick = () => {
                if (idx > 0) { appState.activeEntryId = appState.activeEntries[idx - 1].id; renderEntryDetailView(appState.activeEntries[idx - 1]); }
            };
            document.getElementById('next-entry-btn').onclick = () => {
                if (idx < appState.activeEntries.length - 1) { appState.activeEntryId = appState.activeEntries[idx + 1].id; renderEntryDetailView(appState.activeEntries[idx + 1]); }
            };
        }

        // --- Tagged Entries Functions ---
        async function handleTagClick(tagName) {
            appState.currentTagName = tagName;
            appState.viewBeforeTagSearch = appState.currentView; 
            appState.entryIdBeforeTagSearch = appState.activeEntryId;
            appState.collectionIdForEntryBeforeTagSearch = appState.activeCollectionId;

            document.getElementById('tagged-entries-loading').classList.remove('hidden');
            document.getElementById('tagged-entries-container').innerHTML = ''; 
            document.getElementById('no-tagged-entries-message').classList.add('hidden');
            navigateTo('taggedEntries'); 

            const entries = await fetchEntriesByTag(tagName);
            appState.taggedEntries = entries; 
            renderTaggedEntriesView(tagName, entries);
            document.getElementById('tagged-entries-loading').classList.add('hidden');
        }

        async function fetchEntriesByTag(tagName) {
            console.log(`Fetching entries for tag: "${tagName}" for user: ${appState.currentUser.id}`);
            try {
                const { data: userCollectionObjects, error: collectionError } = await supabaseClient
                    .from('collections')
                    .select('id')
                    .eq('user_id', appState.currentUser.id);

                if (collectionError) {
                    console.error('Error fetching user collections for tag search:', collectionError);
                    throw collectionError;
                }

                if (!userCollectionObjects || userCollectionObjects.length === 0) {
                    console.log('User has no collections, so no tagged entries can be found.');
                    return []; 
                }

                const userCollectionIds = userCollectionObjects.map(c => c.id);
                console.log('User collection IDs for tag search:', userCollectionIds);

                const { data: entries, error: entriesError } = await supabaseClient
                    .from('entries')
                    .select('*')
                    .in('collection_id', userCollectionIds) 
                    .contains('tags', [tagName])        
                    .order('date', { ascending: false }); // Newest first

                if (entriesError) {
                    console.error('Supabase error fetching entries by tag and collections:', entriesError);
                    throw entriesError;
                }
                console.log(`Fetched entries for tag "${tagName}" in user collections:`, entries);
                return entries || [];
            } catch (error) {
                console.error(`Error in fetchEntriesByTag for tag "${tagName}":`, error);
                const noTaggedMsg = document.getElementById('no-tagged-entries-message');
                noTaggedMsg.textContent = `Error loading entries. Please check console.`;
                noTaggedMsg.classList.remove('hidden');
                return [];
            }
        }

        function renderTaggedEntriesView(tagName, entries) { // entries are newest first
            document.getElementById('tagged-entries-title').textContent = `Entries tagged: "${tagName}"`;
            const container = document.getElementById('tagged-entries-container');
            container.innerHTML = ''; 

            const noTaggedMsg = document.getElementById('no-tagged-entries-message');
            noTaggedMsg.classList.toggle('hidden', entries.length > 0);
            if (entries.length === 0 && !noTaggedMsg.textContent.startsWith("Error")) { 
                 noTaggedMsg.textContent = 'No entries found with this tag.';
            }

            entries.forEach((entry, idx) => { 
                const tile = document.createElement('div');
                tile.className = 'card grid-entry-tile'; 
                tile.dataset.id = entry.id;
                
                let badgeHTML = '';
                if (idx < entries.length - 1) {
                    const currentDate = new Date(entry.date);
                    const olderEntryDate = new Date(entries[idx + 1].date);

                    if (currentDate.getTime() > olderEntryDate.getTime()) {
                        const daysDiff = daysBetween(entry.date, entries[idx + 1].date);
                        if (daysDiff > 0) {
                            badgeHTML = `<span class="days-since-badge">${daysDiff} day${daysDiff > 1 ? 's' : ''} later</span>`;
                        }
                    } else if (currentDate.getTime() === olderEntryDate.getTime()) {
                        badgeHTML = `<span class="days-since-badge">Same day</span>`;
                    }
                }
                
                tile.innerHTML = `
                    <img src="${entry.image_url}" alt="${entry.title}" class="grid-entry-image">
                    <div class="grid-entry-info">
                        ${badgeHTML}
                        <h3 class="grid-entry-title">${entry.title}</h3>
                        <!-- Tags removed from grid view -->
                    </div>`;
                tile.onclick = async () => {
                    appState.activeEntryId = entry.id;
                    appState.activeCollectionId = entry.collection_id; 
                    appState.activeEntries = await loadEntries(entry.collection_id); 
                    renderEntryDetailView(entry);
                    navigateTo('entryDetail');
                };
                container.appendChild(tile); 
            });
        }


        // --- Event Handlers ---
        loginForm.onsubmit = async (e) => {
            e.preventDefault(); loginError.classList.add('hidden'); loginError.textContent = '';
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            try {
                const { error } = await supabaseClient.auth.signInWithPassword({ email, password });
                if (error) throw error;
                await checkAuth();
            } catch (error) { loginError.textContent = error.message; loginError.classList.remove('hidden'); }
        };

        signupForm.onsubmit = async (e) => {
            e.preventDefault(); signupError.classList.add('hidden'); signupError.textContent = '';
            const username = document.getElementById('username').value;
            const phone = document.getElementById('phone').value;
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            try {
                const { data: authData, error: authError } = await supabaseClient.auth.signUp({ email, password });
                if (authError) throw authError;
                if (authData.user) {
                    const { error: profileError } = await supabaseClient.from('profiles').insert({ id: authData.user.id, username, phone });
                    if (profileError) console.error('Profile creation error:', profileError);
                    if (authData.session) { await checkAuth(); } 
                    else { 
                        signupError.textContent = 'Account created! Please check your email to confirm and then log in.';
                        signupError.classList.remove('hidden');
                        signupError.style.color = 'var(--primary-accent)'; 
                        setTimeout(() => navigateTo('login'), 4000);
                    }
                }
            } catch (error) { signupError.textContent = error.message; signupError.classList.remove('hidden'); signupError.style.color = 'var(--danger-color)';}
        };

        document.getElementById('sign-out-btn').onclick = async () => {
            if (confirm("Are you sure you want to sign out?")) {
                await supabaseClient.auth.signOut();
                appState.currentUser = null; appState.collections = []; appState.activeCollectionId = null; appState.activeEntryId = null;
                navigateTo('login');
            }
        };

        document.getElementById('new-collection-btn-home').onclick = () => { document.getElementById('collection-name').value = ''; navigateTo('newCollectionModal'); };
        document.getElementById('cancel-new-collection-btn').onclick = () => navigateTo('home');

        newCollectionForm.onsubmit = async (e) => {
            e.preventDefault();
            try {
                const { error } = await supabaseClient.from('collections').insert({ name: document.getElementById('collection-name').value, user_id: appState.currentUser.id }).select().single();
                if (error) throw error;
                await loadCollections(); renderHomeView(); navigateTo('home');
            } catch (error) { console.error('Error creating collection:', error); alert('Error creating collection.'); }
        };

        document.getElementById('back-to-home-btn').onclick = () => navigateTo('home');
        document.getElementById('add-entry-fab').onclick = () => { renderNewEntryForm(); navigateTo('newEntry'); };
        document.getElementById('back-to-timeline-btn').onclick = () => { appState.activeCollectionId ? renderCollectionTimelineView() : navigateTo('home'); };

        imageUploadInput.onchange = e => {
            const file = e.target.files[0]; if (!file) return;
            appState.selectedImageFile = file;
            imageUploadLabel.classList.add('hidden'); imagePreviewWrapper.classList.remove('hidden');
            const reader = new FileReader();
            reader.onload = async evt => {
                appState.selectedImageDataURL = evt.target.result; imagePreview.src = appState.selectedImageDataURL;
                appState.currentTags = []; 
                appState.aiSuggestedTags = [];
                _renderTagBar(tagBar, 'custom-tag-input', appState.currentTags, appState.aiSuggestedTags, handleAddCustomTagForNewEntry, handleRemoveSelectedTagForNewEntry, handleSelectSuggestedTagForNewEntry);
                datePromptMessage.classList.add('hidden'); entryDateInput.value = formatDate(new Date());
                EXIF.getData(file, function() {
                    let exifDateFound = false; const dto = EXIF.getTag(this, "DateTimeOriginal");
                    if (dto) { try { const [datePart] = dto.split(' '); const [year, month, day] = datePart.split(':'); if (year && month && day && !isNaN(new Date(`${year}-${month}-${day}`))) { entryDateInput.value = `${year}-${month}-${day}`; exifDateFound = true; }} catch (ex) { console.warn("EXIF parse error:", ex); }}
                    if (!exifDateFound) { datePromptMessage.textContent = 'No date in image. Set manually or use today.'; datePromptMessage.classList.remove('hidden');}
                });
                const predictedTags = await predictTagsForImage(appState.selectedImageDataURL);
                appState.aiSuggestedTags = predictedTags.filter(pt => !appState.currentTags.includes(pt)); 
                _renderTagBar(tagBar, 'custom-tag-input', appState.currentTags, appState.aiSuggestedTags, handleAddCustomTagForNewEntry, handleRemoveSelectedTagForNewEntry, handleSelectSuggestedTagForNewEntry);
            };
            reader.readAsDataURL(file);
        };

        document.getElementById('remove-image-btn').onclick = () => {
            imagePreviewWrapper.classList.add('hidden'); imageUploadLabel.classList.remove('hidden');
            imagePreview.src = '#'; imageUploadInput.value = null; 
            appState.selectedImageFile = null; appState.selectedImageDataURL = null; appState.currentTags = []; appState.aiSuggestedTags = [];
            _renderTagBar(tagBar, 'custom-tag-input', appState.currentTags, appState.aiSuggestedTags, handleAddCustomTagForNewEntry, handleRemoveSelectedTagForNewEntry, handleSelectSuggestedTagForNewEntry);
            imageProcessingLoader.classList.add('hidden'); datePromptMessage.classList.add('hidden'); entryDateInput.value = formatDate(new Date());
        };

        document.getElementById('add-custom-tag-btn').onclick = handleAddCustomTagForNewEntry;
        tagBar.addEventListener('keypress', e => { if (e.target.id === 'custom-tag-input' && e.key === 'Enter') { e.preventDefault(); handleAddCustomTagForNewEntry(); }});

        newEntryForm.onsubmit = async (e) => {
            e.preventDefault(); if (!appState.selectedImageFile) { alert("Please select an image."); return; }
            entryUploadLoader.classList.remove('hidden'); document.getElementById('create-entry-btn').disabled = true;
            try {
                const imageUrl = await uploadImage(appState.selectedImageFile, appState.currentUser.id);
                const entryData = { 
                    collection_id: appState.activeCollectionId, 
                    title: document.getElementById('entry-title').value, 
                    notes: document.getElementById('entry-notes').value, 
                    date: entryDateInput.value, 
                    image_url: imageUrl, 
                    tags: appState.currentTags.filter(Boolean) 
                };
                const { error } = await supabaseClient.from('entries').insert(entryData).select().single();
                if (error) throw error;
                await renderCollectionTimelineView();
            } catch (error) { console.error('Error in entry creation process:', error); alert(`Error creating entry: ${error.message}`);
            } finally { entryUploadLoader.classList.add('hidden'); document.getElementById('create-entry-btn').disabled = false; }
        };

        document.getElementById('back-to-timeline-from-detail-btn').onclick = () => { appState.activeCollectionId ? renderCollectionTimelineView() : navigateTo('home'); };
        
        document.getElementById('back-from-tagged-view-btn').onclick = async () => {
            if (appState.viewBeforeTagSearch === 'entryDetail' && appState.entryIdBeforeTagSearch && appState.collectionIdForEntryBeforeTagSearch) {
                appState.activeEntryId = appState.entryIdBeforeTagSearch;
                appState.activeCollectionId = appState.collectionIdForEntryBeforeTagSearch;
                appState.activeEntries = await loadEntries(appState.activeCollectionId); 
                const originalEntry = appState.activeEntries.find(e => e.id === appState.entryIdBeforeTagSearch);
                if (originalEntry) {
                    renderEntryDetailView(originalEntry);
                    navigateTo('entryDetail');
                } else {
                    console.warn("Could not find original entry to go back to. Navigating home.");
                    navigateTo('home');
                }
            } else {
                navigateTo('home');
            }
        };


        document.getElementById('delete-collection-btn').onclick = async () => {
            const col = appState.collections.find(c => c.id === appState.activeCollectionId);
            if (!col || !confirm(`Delete collection "${col.name}" and ALL its entries? This cannot be undone.`)) return;
            try {
                const { error: entriesError } = await supabaseClient.from('entries').delete().eq('collection_id', appState.activeCollectionId);
                if (entriesError) throw entriesError;

                const { error } = await supabaseClient.from('collections').delete().eq('id', appState.activeCollectionId);
                if (error) throw error;
                
                appState.activeCollectionId = null; await loadCollections(); renderHomeView(); navigateTo('home');
            } catch (error) { console.error('Error deleting collection:', error); alert('Error deleting collection.'); }
        };

        document.getElementById('delete-entry-btn').onclick = async () => {
            if (!appState.activeEntryId || !confirm("Are you sure you want to delete this entry?")) return;
            try {
                const { error } = await supabaseClient.from('entries').delete().eq('id', appState.activeEntryId);
                if (error) throw error;
                appState.activeEntryId = null; await renderCollectionTimelineView();
            } catch (error) { console.error('Error deleting entry:', error); alert('Error deleting entry.'); }
        };

        document.getElementById('switch-to-signup').onclick = () => navigateTo('signup');
        document.getElementById('switch-to-login').onclick = () => navigateTo('login');

        document.getElementById('edit-entry-btn').onclick = () => {
            const entry = appState.activeEntries.find(e => e.id === appState.activeEntryId);
            if (entry) { renderEditEntryForm(entry); navigateTo('editEntry'); }
        };
        document.getElementById('back-to-detail-btn').onclick = () => {
            const entry = appState.activeEntries.find(e => e.id === appState.activeEntryId);
            if (entry) { renderEntryDetailView(entry); navigateTo('entryDetail'); } 
            else { renderCollectionTimelineView(); }
        };

        document.getElementById('edit-add-custom-tag-btn').onclick = handleAddCustomTagForEditEntry;
        editTagBarEl.addEventListener('keypress', e => { if (e.target.id === 'edit-custom-tag-input' && e.key === 'Enter') { e.preventDefault(); handleAddCustomTagForEditEntry(); }});

        editEntryForm.onsubmit = async (e) => {
            e.preventDefault();
            const editLoader = document.getElementById('edit-upload-loader'); const saveBtn = document.getElementById('save-entry-btn');
            editLoader.classList.remove('hidden'); saveBtn.disabled = true;
            try {
                const { error } = await supabaseClient.from('entries').update({ title: document.getElementById('edit-entry-title').value, notes: document.getElementById('edit-entry-notes').value, date: document.getElementById('edit-entry-date').value, tags: appState.currentTags.filter(Boolean) }).eq('id', appState.activeEntryId);
                if (error) throw error;
                appState.activeEntries = await loadEntries(appState.activeCollectionId); 
                const updatedEntry = appState.activeEntries.find(e => e.id === appState.activeEntryId);
                if (updatedEntry) { renderEntryDetailView(updatedEntry); navigateTo('entryDetail'); } 
                else { renderCollectionTimelineView(); }
            } catch (error) { console.error('Error updating entry:', error); alert('Error updating entry.');
            } finally { editLoader.classList.add('hidden'); saveBtn.disabled = false; }
        };

        let touchstartX = 0, touchendX = 0;
        const entryDetailViewEl = views.entryDetail;
        function handleSwipe() {
            const swipeThreshold = 50; 
            if (touchendX < touchstartX - swipeThreshold) document.getElementById('next-entry-btn').click();
            if (touchendX > touchstartX + swipeThreshold) document.getElementById('prev-entry-btn').click();
        }
        entryDetailViewEl.addEventListener('touchstart', e => { touchstartX = e.changedTouches[0].screenX; }, {passive: true});
        entryDetailViewEl.addEventListener('touchend', e => { touchendX = e.changedTouches[0].screenX; handleSwipe(); }, {passive: true});

        document.addEventListener('DOMContentLoaded', async () => { await checkAuth(); });
    </script>
</body>
</html>

