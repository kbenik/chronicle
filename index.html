<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Evoly</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exif-js/2.3.0/exif.min.js"></script>

    <style>
        :root {
            /* Logo-Based Colors */
            --logo-light-green: #a2ada3; 
            --logo-light-green-darker: #8c9a8d; 
            --logo-light-green-rgb: 162, 173, 163;

            --logo-dark-slate: #3c4a54;   
            --logo-dark-slate-lighter: #4c5a65; 

            /* Theme Mapping */
            --primary-accent: var(--logo-light-green);
            --primary-accent-darker: var(--logo-light-green-darker);
            --primary-accent-rgb: var(--logo-light-green-rgb);

            --primary-button-bg: var(--logo-dark-slate); 
            --primary-button-text: #FFFFFF;
            --primary-button-hover-bg: var(--logo-dark-slate-lighter);

            --secondary-button-bg: #F0F0F0; 
            --secondary-button-text: #333333;
            --secondary-button-border: #DCDCDC;
            --secondary-button-hover-bg: #E0E0E0;

            --background-main: #FFFFFF; 
            --background-gradient-start: rgba(245, 247, 245, 0.5); 
            --background-gradient-end: rgba(240, 242, 240, 0.3);   
            
            --card-bg: #FFFFFF;
            --card-border: #ECECEC;

            --text-primary: #2c3e50; 
            --text-secondary: #7f8c8d; 
            
            --input-bg: #FFFFFF;
            --input-border: #CED4DA;
            --input-focus-border: var(--primary-accent); 
            --input-focus-shadow-rgb: var(--primary-accent-rgb);

            --danger-color: #D93025; 
            --danger-bg: #FCE8E6;
            --danger-border: #F6C8C4;
            --soft-danger-color: #E57373; 
            --soft-danger-hover-color: #EF5350; 


            --border-radius-main: 10px; 
            --border-radius-small: 6px;
            --box-shadow-main: 0 4px 12px rgba(0,0,0,0.06);
            --box-shadow-light: 0 2px 6px rgba(0,0,0,0.04);
            --transition-speed: 0.2s ease;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            margin: 0;
            background-color: var(--background-main);
            background-image: linear-gradient(135deg, var(--background-gradient-start) 0%, var(--background-gradient-end) 100%);
            color: var(--text-primary);
            line-height: 1.6;
            overscroll-behavior-y: contain;
        }

        .app-container {
            max-width: 700px;
            margin: 0 auto;
            padding: 0;
        }

        .view {
            padding: 25px; 
            min-height: calc(100vh - 50px); 
            box-sizing: border-box;
        }

        h1, h2 {
            color: var(--text-primary);
            margin-top: 0;
            font-weight: 600;
        }
        h1 { font-size: 2.1em; margin-bottom: 0.8em; }
        h2 { font-size: 1.7em; margin-bottom: 0.6em; }
        h3 { font-size: 1.25em; color: var(--text-primary); margin: 0 0 8px 0; font-weight: 500; }


        button, input[type="submit"] {
            background-color: var(--primary-button-bg);
            color: var(--primary-button-text);
            border: none;
            padding: 12px 22px; 
            border-radius: var(--border-radius-main);
            cursor: pointer;
            font-size: 1em;
            font-weight: 500;
            transition: background-color var(--transition-speed), transform var(--transition-speed);
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        button:hover, input[type="submit"]:hover {
            background-color: var(--primary-button-hover-bg);
            transform: translateY(-1px);
        }
        button:active, input[type="submit"]:active {
            transform: translateY(0px);
        }

        button.secondary {
            background-color: var(--secondary-button-bg);
            color: var(--secondary-button-text);
            border: 1px solid var(--secondary-button-border);
            box-shadow: none;
        }
        button.secondary:hover {
            background-color: var(--secondary-button-hover-bg);
        }

        button.danger {
            background-color: var(--danger-color); 
            color: var(--primary-button-text);
        }
        button.danger:hover {
            background-color: #C0271B; 
        }

        .icon-button {
            background: none;
            border: none;
            padding: 8px; 
            cursor: pointer;
            border-radius: 50%; 
            display: inline-flex;
            align-items: center;
            justify-content: center;
            transition: background-color var(--transition-speed), color var(--transition-speed);
            line-height: 1; 
        }
        .icon-button svg {
            width: 20px; 
            height: 20px;
        }

        .icon-button.danger-icon { 
            color: var(--soft-danger-color);
        }
        .icon-button.danger-icon:hover {
            background-color: rgba(229, 115, 115, 0.1); 
            color: var(--soft-danger-hover-color);
        }


        input[type="text"], input[type="email"], input[type="tel"], input[type="password"], input[type="date"], textarea {
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            border: 1px solid var(--input-border);
            border-radius: var(--border-radius-small); 
            font-size: 1em;
            box-sizing: border-box;
            background-color: var(--input-bg);
            color: var(--text-primary);
            transition: border-color var(--transition-speed), box-shadow var(--transition-speed);
        }
        input[type="text"]:focus, input[type="email"]:focus, input[type="tel"]:focus, input[type="password"]:focus, input[type="date"]:focus, textarea:focus {
            outline: none;
            border-color: var(--input-focus-border);
            box-shadow: 0 0 0 3px rgba(var(--input-focus-shadow-rgb), 0.15);
        }
        ::placeholder {
            color: var(--text-secondary);
            opacity: 0.8;
        }
        textarea {
            min-height: 120px;
            resize: vertical;
        }

        .form-group { margin-bottom: 18px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-secondary); font-size: 0.9em;}

        .card {
            background-color: var(--card-bg);
            border-radius: var(--border-radius-main);
            margin-bottom: 0; 
            box-shadow: var(--box-shadow-main);
            transition: transform var(--transition-speed), box-shadow var(--transition-speed);
            border: 1px solid var(--card-border);
        }
        .card.collection-card { 
             cursor: pointer;
             padding: 20px; 
        }
        .card.collection-card:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 6px 16px rgba(0,0,0,0.08);
        }


        .fab { 
            position: fixed; bottom: 30px; right: 30px;
            width: 56px; height: 56px; border-radius: 50%;
            background-color: var(--primary-button-bg); color: var(--primary-button-text);
            font-size: 24px; display: flex; align-items: center; justify-content: center;
            box-shadow: 0 6px 12px rgba(0,0,0,0.15); cursor: pointer; z-index: 1000;
            transition: background-color var(--transition-speed), transform var(--transition-speed);
        }
        .fab:hover { 
            background-color: var(--primary-button-hover-bg); 
            transform: scale(1.05);
        }

        #login-view, #signup-view { 
            display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center;
        }
        #new-collection-modal-view { 
             display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center;
        }

        #login-view form, #signup-view form, #new-collection-modal-view form {
            width: 100%; max-width: 420px; 
            background-color: var(--card-bg);
            padding: 35px; 
            border-radius: var(--border-radius-main); 
            box-shadow: var(--box-shadow-main);
            border: 1px solid var(--card-border);
        }
        
        .auth-logo {
            max-width: 220px; 
            height: auto;
            margin-bottom: 20px;
        }

        #login-view p, #signup-view p { 
            text-align: center;
            color: var(--text-secondary);
            margin-bottom: 30px;
            margin-top: 5px; 
        }

        .header-app-icon {
            width: 36px; 
            height: 36px;
            margin-right: 12px; 
            flex-shrink: 0; 
        }

        /* General Header Styling */
        .view > header {
            display: flex;
            align-items: flex-start; 
            margin-bottom: 25px;
            flex-wrap: wrap; 
        }
        /* Specific for Home View Header */
        #home-view > header {
            justify-content: flex-start; 
        }
         #home-view > header #greeting { 
            margin-top: 0; 
            line-height: 36px; 
            margin-bottom: 0; 
        }
        #home-view > header .header-actions {
            margin-left: auto; 
            align-self: center; 
        }

        /* Headers with Back Button */
        #collection-timeline-view > header,
        #new-entry-view > header,
        #entry-detail-view > header,
        #edit-entry-view > header,
        #tagged-entries-view > header {
            justify-content: flex-start; 
        }

        #collection-timeline-view > header h2,
        #tagged-entries-view > header h2,
        #new-entry-view > header h2,
        #entry-detail-view > header h2, 
        #edit-entry-view > header h2 {
            margin-left: 15px; 
            margin-right: 15px; 
            flex-grow: 1; 
            margin-top: 0; 
            margin-bottom: 0; 
            line-height: 36px; 
        }
        #collection-timeline-view > header .header-actions {
             margin-left: auto;
             align-self: center; 
        }


        /* Grid Container Styling */
        #entries-timeline-container,
        #tagged-entries-container {
            display: grid;
            gap: 15px; 
            grid-template-columns: repeat(2, 1fr); 
        }

        @media (min-width: 480px) { 
            #entries-timeline-container,
            #tagged-entries-container {
                grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            }
        }
        
        .collection-card h3 { margin-bottom: 8px; font-size: 1.3em;}
        .collection-card p { font-size: 0.9em; color: var(--text-secondary); margin: 0;}

        /* New Grid Entry Tile Styling */
        .grid-entry-tile { 
            display: flex;
            flex-direction: column;
            overflow: hidden; 
            cursor: pointer;
        }

        .grid-entry-tile:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 18px rgba(0,0,0,0.1);
        }

        .grid-entry-image {
            width: 100%;
            height: 160px; 
            object-fit: cover;
            display: block; 
            background-color: #f0f0f0; /* Placeholder color if no image */
        }

        .grid-entry-info {
            padding: 10px;
            display: flex;
            flex-direction: column;
            flex-grow: 1; 
        }
        
        .grid-entry-info .days-since-badge { 
            font-size: 0.7em; 
            padding: 2px 5px; 
            margin-bottom: 6px; 
            align-self: flex-start; 
        }

        .grid-entry-title { 
            font-size: 1.05em; 
            font-weight: 600;
            margin: 0 0 8px 0; 
            color: var(--text-primary);
            line-height: 1.3;
            word-break: break-word; 
        }
        
        .tag-chips { display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 0px; } 
        .tag-chip {
            background-color: var(--secondary-button-bg); 
            color: var(--secondary-button-text);
            padding: 4px 10px; 
            border-radius: 15px; 
            font-size: 0.8em;
            border: 1px solid var(--secondary-button-border);
        }
        .clickable-tag { 
            cursor: pointer;
            transition: background-color var(--transition-speed), color var(--transition-speed), border-color var(--transition-speed);
        }
        .clickable-tag:hover {
            background-color: var(--primary-accent) !important; 
            color: var(--primary-button-text) !important; 
            border-color: var(--primary-accent) !important;
        }
        .days-since-badge { 
            font-size: 0.8em; 
            color: var(--primary-accent); 
            font-weight: 500; 
            background-color: rgba(var(--primary-accent-rgb), 0.15); 
            padding: 3px 6px;
            border-radius: var(--border-radius-small);
            display: inline-block;
        }

        /* Image Upload and Preview Styling */
        #new-entry-view #image-upload-label {
            display: block; width: 100%; height: 200px;
            border: 2px dashed var(--input-border); 
            border-radius: var(--border-radius-main);
            display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer;
            margin-bottom: 20px; 
            background-color: #F8F9FA; 
            text-align: center; color: var(--text-secondary);
            transition: border-color var(--transition-speed), background-color var(--transition-speed);
        }
        #new-entry-view #image-upload-label:hover { 
            border-color: var(--primary-accent); 
            background-color: #FDFBFF; 
        }
        #new-entry-view #image-upload-label svg {
            color: var(--primary-accent); 
            margin-bottom: 10px;
            width: 52px; height: 52px;
        }
        
        #image-previews-container, #edit-existing-images-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }
        .image-preview-item {
            position: relative;
            width: 100px;
            height: 100px;
            border: 1px solid var(--card-border);
            border-radius: var(--border-radius-small);
            overflow: hidden;
        }
        .image-preview-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }
        .remove-preview-btn {
            position: absolute;
            top: 4px;
            right: 4px;
            background: rgba(217, 48, 37, 0.85);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            width: 24px;
            height: 24px;
            font-size: 16px;
            line-height: 22px;
            text-align: center;
            padding: 0;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }


        #date-prompt-message { 
            font-size: 0.9em; 
            color: var(--text-secondary); 
            margin-top: -10px; margin-bottom: 10px; 
        }
        #tag-bar, #edit-tag-bar {
            display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 15px;
            padding: 12px; 
            border: 1px solid var(--input-border);
            border-radius: var(--border-radius-small); 
            background-color: var(--input-bg);
        }
        .suggested-tag {
            padding: 6px 12px; 
            border-radius: 18px;
            background-color: var(--secondary-button-bg);
            color: var(--secondary-button-text);
            cursor: pointer; 
            transition: background-color var(--transition-speed), color var(--transition-speed), border-color var(--transition-speed);
            border: 1px solid var(--secondary-button-border);
            font-size: 0.9em;
        }
        .suggested-tag:hover {
            background-color: var(--secondary-button-hover-bg);
            border-color: #C0C0C0;
        }
        .suggested-tag.selected { 
            background-color: var(--primary-accent); 
            color: var(--primary-button-text); 
            border-color: var(--primary-accent-darker);
        }
        #custom-tag-input, #edit-custom-tag-input { 
            flex-grow: 1; 
            border: none; 
            padding: 6px; 
            min-width: 100px; 
            background-color: transparent; 
            color: var(--text-primary);
            font-size: 0.9em;
        }
        #custom-tag-input:focus, #edit-custom-tag-input:focus {
            outline: none;
        }


        #entry-detail-view #detail-image-container {
            width: 100%; height: 40vh; /* Main image display area */
            background-color: #F8F9FA; 
            display: flex; align-items: center; justify-content: center; margin-bottom: 15px; /* Reduced bottom margin */
            border-radius: var(--border-radius-main);
            overflow: hidden;
        }
        #entry-detail-view #detail-image { 
            max-width: 100%; 
            max-height: 100%; 
            object-fit: contain; 
            cursor: zoom-in;
        }
        #detail-thumbnails-container {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 20px;
            justify-content: flex-start; /* Align thumbnails to the start */
        }
        .detail-thumbnail {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: var(--border-radius-small);
            cursor: pointer;
            border: 2px solid transparent;
            transition: border-color 0.2s;
        }
        .detail-thumbnail.active-thumb {
            border-color: var(--primary-accent);
        }


        #entry-detail-view #detail-content { padding: 0 10px; }
        #entry-detail-view #detail-content h2 { 
            margin-top: 0; 
            font-size: 1.8em; 
            margin-bottom: 15px;
        }
        #entry-detail-view #detail-notes {
            color: var(--text-secondary);
            line-height: 1.7;
            margin-bottom: 20px;
            font-size: 1em;
        }
        #entry-detail-view #detail-tags .tag-chip { 
            font-size: 0.9em; 
        }
        #entry-detail-view #detail-metadata { 
            font-size: 0.9em; 
            color: var(--text-secondary); 
            margin-top: 15px; 
        }
        .detail-nav { display: flex; justify-content: space-between; margin-top: 25px; gap: 10px; }
        .detail-nav button {
            flex-grow: 1;
        }
        .detail-nav button#edit-entry-btn { 
            background-color: var(--primary-button-bg); 
            color: var(--primary-button-text);
        }
        .detail-nav button#edit-entry-btn:hover {
            background-color: var(--primary-button-hover-bg);
        }
        #delete-entry-btn { margin-top: 20px; display: block; width: 100%; }
        
        .loader {
            border: 4px solid var(--secondary-button-bg); 
            border-top: 4px solid var(--primary-accent); 
            border-radius: 50%; width: 30px; height: 30px;
            animation: spin 1s linear infinite; margin: 20px auto;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .hidden { display: none !important; }
        .text-center { text-align: center; }
        .my-2 { margin-top: 1rem; margin-bottom: 1rem; }
        
        .back-button {
            background-color: var(--secondary-button-bg); 
            border: 1px solid var(--secondary-button-border); 
            color: var(--primary-accent); 
            font-size: 0.9em; 
            cursor: pointer;
            padding: 8px 16px; 
            margin-right: 0; 
            font-weight: 500;
            border-radius: var(--border-radius-main); 
            transition: color var(--transition-speed), background-color var(--transition-speed), border-color var(--transition-speed);
            text-decoration: none; 
            display: inline-flex; 
            align-items: center;
            height: 36px; 
            box-sizing: border-box;
        }
        .back-button:hover {
            background-color: var(--primary-button-hover-bg); 
            color: var(--primary-button-text); 
            border-color: var(--primary-button-hover-bg); 
        }
        
        .error-message {
            color: var(--danger-color);
            font-size: 0.9em;
            margin-top: -5px;
            margin-bottom: 15px;
            background-color: var(--danger-bg);
            padding: 10px;
            border-radius: var(--border-radius-small);
            border: 1px solid var(--danger-border);
            text-align: left;
        }
        /* Success message styling (for email verification note) */
        .success-message {
            color: var(--primary-accent-darker); /* Or a distinct success color */
            font-size: 0.9em;
            margin-top: 10px; /* Adjust as needed */
            margin-bottom: 15px;
            background-color: rgba(var(--primary-accent-rgb), 0.1); /* Light background */
            padding: 10px;
            border-radius: var(--border-radius-small);
            border: 1px solid var(--primary-accent);
            text-align: left;
        }
        
        .switch-link {
            color: var(--primary-accent); 
            cursor: pointer;
            text-decoration: underline;
            margin-top: 20px;
            display: inline-block;
            font-size: 0.9em;
            transition: color var(--transition-speed);
        }
        .switch-link:hover {
            color: var(--primary-accent-darker);
        }

        /* Edit Entry View Image Styling */
        #edit-entry-view .form-group-images label { margin-bottom: 10px; display: block; }
        #edit-add-more-images-label {
            display: inline-block;
            padding: 10px 15px;
            background-color: var(--secondary-button-bg);
            color: var(--secondary-button-text);
            border: 1px solid var(--secondary-button-border);
            border-radius: var(--border-radius-small);
            cursor: pointer;
            margin-top: 10px;
            font-size: 0.9em;
        }
        #edit-add-more-images-label:hover {
            background-color: var(--secondary-button-hover-bg);
        }
        #edit-new-image-previews-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px; /* Space above new previews if any */
        }


        /* Lightbox Styles */
        #lightbox-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.85);
            display: flex; 
            align-items: center;
            justify-content: center;
            z-index: 2000; 
            padding: 15px; 
            box-sizing: border-box;
        }

        #lightbox-content {
            position: relative; 
            max-width: 95vw;    
            max-height: 95vh;   
            display: flex;      
            align-items: center;
            justify-content: center;
            overflow: hidden;   
            background-color: #111; 
            border-radius: var(--border-radius-small);
        }

        #lightbox-image {
            display: block;
            max-width: 100%; 
            max-height: 100%;
            object-fit: contain; 
            transition: transform 0.2s ease-out;
            transform-origin: center center; 
        }

        #lightbox-controls {
            position: absolute; 
            top: 20px;          
            right: 20px;         
            display: flex;
            flex-direction: column; 
            gap: 12px;
            z-index: 2001; 
        }

        .lightbox-control-btn {
            background-color: rgba(40, 40, 40, 0.65);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.25);
            border-radius: 50%;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background-color 0.2s;
            padding: 0; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .lightbox-control-btn svg {
            width: 22px; 
            height: 22px;
            pointer-events: none; 
        }

        .lightbox-control-btn:hover {
            background-color: rgba(70, 70, 70, 0.85);
        }
    </style>
</head>
<body>
    <div id="app-container">
        <!-- Login View -->
        <div id="login-view" class="view hidden">
            <form id="login-form">
                <img src="https://wgjxmpahcfhzgflcnlib.supabase.co/storage/v1/object/public/entry-images/Icon/evoly%20icon.png" alt="Evoly Logo" class="auth-logo">
                <p>Track your journeys, one photo at a time.</p>
                <div class="form-group">
                    <label for="login-email">Email</label>
                    <input type="email" id="login-email" required>
                </div>
                <div class="form-group">
                    <label for="login-password">Password</label>
                    <input type="password" id="login-password" required>
                </div>
                <button type="submit">Sign In</button>
                <div id="login-error" class="error-message hidden"></div>
                <div id="login-info" class="success-message hidden"></div> <!-- For info like "check email" -->
                <span class="switch-link" id="switch-to-signup">Don't have an account? Sign up</span>
            </form>
        </div>

        <!-- Signup View -->
        <div id="signup-view" class="view">
            <form id="signup-form">
                <img src="https://wgjxmpahcfhzgflcnlib.supabase.co/storage/v1/object/public/entry-images/Icon/evoly%20icon.png" alt="Evoly Logo" class="auth-logo">
                <p>Track your journeys, one photo at a time.</p>
                <div class="form-group">
                    <label for="username">Username</label>
                    <input type="text" id="username" required>
                </div>
                <div class="form-group">
                    <label for="phone">Phone (Optional)</label>
                    <input type="tel" id="phone">
                </div>
                <div class="form-group">
                    <label for="email">Email</label>
                    <input type="email" id="email" required>
                </div>
                <div class="form-group">
                    <label for="password">Password</label>
                    <input type="password" id="password" required>
                </div>
                <button type="submit">Sign Up</button>
                <div id="signup-error" class="error-message hidden"></div>
                <div id="signup-success" class="success-message hidden"></div> <!-- For "check email" message -->
                <span class="switch-link" id="switch-to-login">Already have an account? Sign in</span>
            </form>
        </div>

        <!-- Home View -->
        <div id="home-view" class="view hidden">
            <header>
                <img src="https://wgjxmpahcfhzgflcnlib.supabase.co/storage/v1/object/public/entry-images/Icon/evoly%20icon%20small.png" alt="Evoly Small Icon" class="header-app-icon">
                <h1 id="greeting">Welcome!</h1>
                <div class="header-actions">
                    <button id="new-collection-btn-home">New Collection</button>
                    <button id="sign-out-btn" class="secondary">Sign Out</button>
                </div>
            </header>
            <div id="collections-container">
            </div>
            <p id="no-collections-message" class="text-center my-2 hidden">No collections yet. Start your first one!</p>
            <div id="collections-loading" class="loader hidden"></div>
        </div>

        <!-- New Collection Modal/View -->
        <div id="new-collection-modal-view" class="view hidden">
            <form id="new-collection-form">
                <h2>New Collection</h2>
                <div class="form-group">
                    <label for="collection-name">Collection Name</label>
                    <input type="text" id="collection-name" required>
                </div>
                <button type="submit">Create Collection</button>
                <button type="button" class="secondary" id="cancel-new-collection-btn" style="margin-top: 10px;">Cancel</button>
            </form>
        </div>
        
        <!-- Collection Timeline View -->
        <div id="collection-timeline-view" class="view hidden">
            <header>
                <img src="https://wgjxmpahcfhzgflcnlib.supabase.co/storage/v1/object/public/entry-images/Icon/evoly%20icon%20small.png" alt="Evoly Small Icon" class="header-app-icon">
                <button class="back-button" id="back-to-home-btn">< Home</button>
                <h2 id="collection-title-timeline">Collection Timeline</h2>
                <div class="header-actions">
                    <button id="delete-collection-btn" class="icon-button danger-icon" title="Delete Collection">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-trash3" viewBox="0 0 16 16">
                            <path d="M6.5 1h3a.5.5 0 0 1 .5.5v1H6v-1a.5.5 0 0 1 .5-.5M11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3A1.5 1.5 0 0 0 5 1.5v1H1.5a.5.5 0 0 0 0 1h.538l.853 10.66A2 2 0 0 0 4.885 16h6.23a2 2 0 0 0 1.994-1.84l.853-10.66h.538a.5.5 0 0 0 0-1zm-1 .722L9.78 14H6.22L5.5 3.222zM7.5 5.5a.5.5 0 0 1 .5.5v7a.5.5 0 0 1-1 0v-7a.5.5 0 0 1 .5-.5m3 0a.5.5 0 0 1 .5.5v7a.5.5 0 0 1-1 0v-7a.5.5 0 0 1 .5-.5"/>
                        </svg>
                    </button>
                </div>
            </header>
            <div id="entries-timeline-container"> 
            </div>
            <p id="no-entries-message" class="text-center my-2 hidden">No entries yet. Add your first one!</p>
            <div id="entries-loading" class="loader hidden"></div>
            <button id="add-entry-fab" class="fab">+</button>
        </div>

        <!-- New Entry View -->
        <div id="new-entry-view" class="view hidden">
            <header>
                 <img src="https://wgjxmpahcfhzgflcnlib.supabase.co/storage/v1/object/public/entry-images/Icon/evoly%20icon%20small.png" alt="Evoly Small Icon" class="header-app-icon">
                 <button class="back-button" id="back-to-timeline-btn">< Cancel</button>
                 <h2 id="new-entry-title-header">New Entry</h2>
            </header>
            <form id="new-entry-form">
                <input type="file" id="image-upload" accept="image/*" class="hidden" multiple>
                <label for="image-upload" id="image-upload-label">
                    <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" fill="currentColor" class="bi bi-camera" viewBox="0 0 16 16">
                        <path d="M15 12a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1V6a1 1 0 0 1 1-1h1.172a3 3 0 0 0 2.12-.879l.83-.828A1 1 0 0 1 6.827 3h2.344a1 1 0 0 1 .707.293l.828.828A3 3 0 0 0 12.828 5H14a1 1 0 0 1 1 1v6zM2 4a2 2 0 0 0-2 2v6a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2h-1.172a2 2 0 0 1-1.414-.586l-.828-.828A2 2 0 0 0 9.172 2H6.828a2 2 0 0 0-1.414.586l-.828.828A2 2 0 0 1 3.172 4H2z"/>
                        <path d="M8 11a2.5 2.5 0 1 1 0-5 2.5 2.5 0 0 1 0 5zm0 1a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7zM3 6.5a.5.5 0 1 1-1 0 .5.5 0 0 1 1 0z"/>
                    </svg>
                    <p>Tap to select or snap photo(s)</p>
                </label>
                
                <div id="image-previews-container">
                    <!-- Image previews will be dynamically added here -->
                </div>
                <div id="image-processing-loader" class="loader hidden"></div>

                <div class="form-group">
                    <label for="entry-date">Date</label>
                    <input type="date" id="entry-date" required>
                    <p id="date-prompt-message" class="hidden">Please set the date manually.</p>
                </div>
                <div class="form-group">
                    <label for="entry-title">Title</label>
                    <input type="text" id="entry-title" required>
                </div>
                <div class="form-group">
                    <label for="entry-notes">Notes/Observations</label>
                    <textarea id="entry-notes"></textarea>
                </div>
                <div class="form-group">
                    <label>Tags (AI suggestions for first image, click to toggle, or type your own)</label>
                    <div id="tag-bar">
                        <input type="text" id="custom-tag-input" placeholder="Add custom tag...">
                    </div>
                    <button type="button" id="add-custom-tag-btn" class="secondary" style="margin-top:5px; font-size:0.9em;">Add Tag</button>
                </div>
                <button type="submit" id="create-entry-btn">Create Entry</button>
                <div id="entry-upload-loader" class="loader hidden"></div>
            </form>
        </div>

        <!-- Entry Detail View -->
        <div id="entry-detail-view" class="view hidden">
            <header>
                <img src="https://wgjxmpahcfhzgflcnlib.supabase.co/storage/v1/object/public/entry-images/Icon/evoly%20icon%20small.png" alt="Evoly Small Icon" class="header-app-icon">
                <button class="back-button" id="back-to-timeline-from-detail-btn">< Back to Timeline</button>
            </header>
            <div id="detail-image-container">
                <img id="detail-image" alt="Entry image">
            </div>
            <div id="detail-thumbnails-container">
                <!-- Thumbnails for multiple images will be here -->
            </div>
            <div id="detail-content">
                <h2 id="detail-title">Entry Title</h2>
                <p id="detail-notes">Full narrative here...</p>
                <div id="detail-tags" class="tag-chips"></div>
                <p id="detail-metadata">Date: YYYY-MM-DD</p>
                <div class="detail-nav">
                    <button id="prev-entry-btn" class="secondary">Previous</button>
                    <button id="edit-entry-btn">Edit</button>
                    <button id="next-entry-btn" class="secondary">Next</button>
                </div>
                <button id="delete-entry-btn" class="danger">Delete This Entry</button>
            </div>
        </div>
        
        <!-- Edit Entry View -->
        <div id="edit-entry-view" class="view hidden">
            <header>
                <img src="https://wgjxmpahcfhzgflcnlib.supabase.co/storage/v1/object/public/entry-images/Icon/evoly%20icon%20small.png" alt="Evoly Small Icon" class="header-app-icon">
                <button class="back-button" id="back-to-detail-btn">< Cancel</button>
                <h2 id="edit-entry-title-header">Edit Entry</h2>
            </header>
            <form id="edit-entry-form">
                <div class="form-group form-group-images">
                    <label>Current Images (click Ã— to remove):</label>
                    <div id="edit-existing-images-container">
                        <!-- Existing image previews will be here -->
                    </div>
                </div>
                 <div class="form-group">
                    <label for="edit-add-more-images-input" id="edit-add-more-images-label">Add More Images...</label>
                    <input type="file" id="edit-add-more-images-input" accept="image/*" class="hidden" multiple>
                    <div id="edit-new-image-previews-container">
                        <!-- New image previews for edit view will be here -->
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="edit-entry-date">Date</label>
                    <input type="date" id="edit-entry-date" required>
                </div>
                <div class="form-group">
                    <label for="edit-entry-title">Title</label>
                    <input type="text" id="edit-entry-title" required>
                </div>
                <div class="form-group">
                    <label for="edit-entry-notes">Notes/Observations</label>
                    <textarea id="edit-entry-notes"></textarea>
                </div>
                <div class="form-group">
                    <label>Tags (click to toggle, or type your own)</label>
                    <div id="edit-tag-bar">
                        <input type="text" id="edit-custom-tag-input" placeholder="Add custom tag...">
                    </div>
                    <button type="button" id="edit-add-custom-tag-btn" class="secondary" style="margin-top:5px; font-size:0.9em;">Add Tag</button>
                </div>
                <button type="submit" id="save-entry-btn">Save Changes</button>
                <div id="edit-upload-loader" class="loader hidden"></div>
            </form>
        </div>

        <!-- Tagged Entries View -->
        <div id="tagged-entries-view" class="view hidden">
            <header>
                <img src="https://wgjxmpahcfhzgflcnlib.supabase.co/storage/v1/object/public/entry-images/Icon/evoly%20icon%20small.png" alt="Evoly Small Icon" class="header-app-icon">
                <button class="back-button" id="back-from-tagged-view-btn">< Back</button>
                <h2 id="tagged-entries-title">Entries Tagged: ...</h2>
            </header>
            <div id="tagged-entries-container"> 
            </div>
            <p id="no-tagged-entries-message" class="text-center my-2 hidden">No entries found with this tag.</p>
            <div id="tagged-entries-loading" class="loader hidden"></div>
        </div>

    </div> <!-- End of app-container -->

    <!-- Lightbox Structure -->
    <div id="lightbox-overlay" class="hidden">
        <div id="lightbox-content">
            <img id="lightbox-image" src="#" alt="Lightbox image">
        </div>
        <div id="lightbox-controls">
            <button id="lightbox-zoom-in" title="Zoom In" class="lightbox-control-btn">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M8 0a1 1 0 0 1 1 1v6h6a1 1 0 1 1 0 2H9v6a1 1 0 1 1-2 0V9H1a1 1 0 0 1 0-2h6V1a1 1 0 0 1 1-1z"/>
                </svg>
            </button>
            <button id="lightbox-zoom-out" title="Zoom Out" class="lightbox-control-btn">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M0 8a1 1 0 0 1 1-1h14a1 1 0 1 1 0 2H1a1 1 0 0 1-1-1z"/>
                </svg>
            </button>
            <button id="lightbox-close" title="Close" class="lightbox-control-btn">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z"/>
                </svg>
            </button>
        </div>
    </div>


    <script>
        // Configuration
        const SUPABASE_URL = 'https://wgjxmpahcfhzgflcnlib.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndnanhtcGFoY2ZoemdmbGNubGliIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDcyMzQzNjAsImV4cCI6MjA2MjgxMDM2MH0.6ji6OY6-g8IkdVvR6f9iZAN83qJunCN4EjnVey8_LJc';
        const GOOGLE_CLOUD_VISION_API_KEY = 'AIzaSyDB9lq0UssbbXndJrwVL-TEaplkbPOmk4w';
        
        const { createClient } = supabase;
        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        const appState = {
            currentUser: null, collections: [], currentView: 'signup', 
            activeCollectionId: null, activeEntryId: null, activeEntries: [], 
            newEntrySelectedFiles: [], editingEntryOriginal: null,
            editEntryExistingImageUrls: [], editEntryFilesToAdd: [],
            currentTags: [], aiSuggestedTags: [], currentTagName: null, 
            taggedEntries: [], viewBeforeTagSearch: null, 
            entryIdBeforeTagSearch: null, collectionIdForEntryBeforeTagSearch: null,
            currentDetailImageIndex: 0,
        };

        const views = { /* ... same as before ... */ };
        // (Initialize all view consts as before)
        const loginForm = document.getElementById('login-form');
        const signupForm = document.getElementById('signup-form');
        const newCollectionForm = document.getElementById('new-collection-form');
        const newEntryForm = document.getElementById('new-entry-form');
        const editEntryForm = document.getElementById('edit-entry-form');
        const greetingEl = document.getElementById('greeting');
        const collectionsContainer = document.getElementById('collections-container');
        const noCollectionsMessage = document.getElementById('no-collections-message');
        const collectionsLoading = document.getElementById('collections-loading');
        const collectionTitleTimeline = document.getElementById('collection-title-timeline');
        const entriesTimelineContainer = document.getElementById('entries-timeline-container');
        const noEntriesMessage = document.getElementById('no-entries-message');
        const entriesLoading = document.getElementById('entries-loading');
        const imageUploadInput = document.getElementById('image-upload');
        const imageUploadLabel = document.getElementById('image-upload-label');
        const imagePreviewsContainer = document.getElementById('image-previews-container'); 
        const imageProcessingLoader = document.getElementById('image-processing-loader');
        const entryDateInput = document.getElementById('entry-date');
        const datePromptMessage = document.getElementById('date-prompt-message');
        const tagBar = document.getElementById('tag-bar'); 
        const editTagBarEl = document.getElementById('edit-tag-bar'); 
        const entryUploadLoader = document.getElementById('entry-upload-loader');
        const detailImage = document.getElementById('detail-image');
        const detailThumbnailsContainer = document.getElementById('detail-thumbnails-container');
        const detailTitle = document.getElementById('detail-title');
        const detailNotes = document.getElementById('detail-notes');
        const detailTagsContainer = document.getElementById('detail-tags');
        const detailMetadata = document.getElementById('detail-metadata');
        const loginError = document.getElementById('login-error');
        const loginInfo = document.getElementById('login-info'); // Added for info messages
        const signupError = document.getElementById('signup-error');
        const signupSuccess = document.getElementById('signup-success'); // Added for success messages
        const editExistingImagesContainer = document.getElementById('edit-existing-images-container');
        const editAddMoreImagesInput = document.getElementById('edit-add-more-images-input');
        const editNewImagePreviewsContainer = document.getElementById('edit-new-image-previews-container');
        const lightboxOverlay = document.getElementById('lightbox-overlay');
        const lightboxContent = document.getElementById('lightbox-content');
        const lightboxImage = document.getElementById('lightbox-image');
        const lightboxCloseBtn = document.getElementById('lightbox-close');
        const lightboxZoomInBtn = document.getElementById('lightbox-zoom-in');
        const lightboxZoomOutBtn = document.getElementById('lightbox-zoom-out');
        
        Object.keys(views).forEach(id => { // Initialize views object from DOM
            views[id] = document.getElementById(id + '-view');
        });

        let currentLightboxZoomScale = 1;
        const LIGHTBOX_ZOOM_STEP = 0.2, LIGHTBOX_MIN_ZOOM = 0.4, LIGHTBOX_MAX_ZOOM = 5;   

        function getSanitizedImageUrls(entry) { /* ... same as before ... */ 
            if (!entry || !entry.image_urls) return [];
            if (Array.isArray(entry.image_urls)) return entry.image_urls;
            if (typeof entry.image_urls === 'string') {
                try {
                    const parsed = JSON.parse(entry.image_urls);
                    return Array.isArray(parsed) ? parsed : [];
                } catch (e) {
                    console.warn("Could not parse image_urls string, treating as empty:", entry.image_urls, e);
                    return [];
                }
            }
            return [];
        }
        function navigateTo(viewId) { /* ... same as before ... */ 
            appState.currentView = viewId;
            Object.keys(views).forEach(id => {
                if (views[id]) views[id].classList.add('hidden');
            });
            if (views[viewId]) {
                views[viewId].classList.remove('hidden');
            }
            window.scrollTo(0, 0);
        }
        function formatDate(dateStrOrObj) { /* ... same as before ... */ 
            const date = new Date(dateStrOrObj);
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        function daysBetween(d1Str, d2Str) { /* ... same as before ... */ 
            if (!d1Str || !d2Str) return null;
            const d1 = new Date(d1Str);
            const d2 = new Date(d2Str);
            if (isNaN(d1) || isNaN(d2)) return null;
            const laterDate = Math.max(d1.getTime(), d2.getTime());
            const earlierDate = Math.min(d1.getTime(), d2.getTime());
            return Math.ceil((laterDate - earlierDate) / (1000 * 60 * 60 * 24));
        }

        async function fetchUserProfile(userId) {
            const { data: profile, error } = await supabaseClient
                .from('profiles')
                .select('username, phone')
                .eq('id', userId)
                .single();
            if (error && error.code !== 'PGRST116') { // PGRST116 = 0 rows, not necessarily an error if profile is optional
                console.error('Error fetching profile:', error);
            }
            return profile;
        }

        async function handleUserSession(user) {
            appState.currentUser = user;
            const profile = await fetchUserProfile(user.id);
            if (profile) {
                appState.currentUser.username = profile.username;
                appState.currentUser.phone = profile.phone;
            }
            await loadCollections();
            renderHomeView();
            navigateTo('home');
            // Clear hash from URL after processing
            if (window.location.hash) {
                history.pushState("", document.title, window.location.pathname + window.location.search);
            }
        }

        // Listen for auth state changes (login, logout, token refresh, redirect from email link)
        supabaseClient.auth.onAuthStateChange(async (event, session) => {
            console.log('Auth event:', event, session);
            if (event === 'SIGNED_IN' && session?.user) {
                if (session.user.email_confirmed_at || !session.user.email_confirmed_at && !isEmailConfirmationRequiredForUser(session.user)) { // Added a hypothetical check
                    await handleUserSession(session.user);
                } else if (!session.user.email_confirmed_at) {
                    // User is signed in but email not confirmed.
                    // This case might happen if they sign up, then try to log in before confirming.
                    // Or if they clicked the link but something didn't fully update their local state.
                    console.log("User signed in, but email not confirmed. Displaying info message.");
                    if (appState.currentView === 'login') {
                         loginInfo.textContent = "Please check your email to verify your account before full access.";
                         loginInfo.classList.remove('hidden');
                         loginError.classList.add('hidden');
                    }
                    // We might not navigate away from login/signup here to let them see the message.
                    // Or, if they just verified, a refresh or `getUser` call might soon update `email_confirmed_at`.
                }
            } else if (event === 'SIGNED_OUT') {
                appState.currentUser = null;
                navigateTo('login');
            } else if (event === 'USER_UPDATED' && session?.user) {
                // This might fire after email confirmation if the user object is updated
                if (session.user.email_confirmed_at && appState.currentUser?.id === session.user.id && !appState.currentUser.email_confirmed_at) {
                    console.log("Email confirmed for existing user session.");
                    await handleUserSession(session.user); // Re-process to ensure navigation to home
                } else {
                    appState.currentUser = session.user; // Update current user with any changes
                }
            }
            // Initial check for user when app loads
            if (event === 'INITIAL_SESSION' && session?.user) {
                 if (session.user.email_confirmed_at || !isEmailConfirmationRequiredForUser(session.user)) {
                    await handleUserSession(session.user);
                } else {
                    console.log("Initial session, but email not confirmed. User should verify.");
                     if (appState.currentView !== 'home' ) { // Don't show on home if they somehow got there
                        navigateTo('login');
                        loginInfo.textContent = "Please check your email to complete verification.";
                        loginInfo.classList.remove('hidden');
                     }
                }
            } else if (event === 'INITIAL_SESSION' && !session) {
                 // No user on initial load, determine view based on URL or default to signup/login
                if (!window.location.hash.includes('access_token')) { // Don't navigate if tokens are in hash (being processed)
                    navigateTo('signup');
                }
            }
        });
        
        // Hypothetical function to check if confirmation is actually required by Supabase settings
        // In a real app, you'd know this from your Supabase config (Secure email change ON/OFF)
        function isEmailConfirmationRequiredForUser(user) {
            // This is a placeholder. Supabase's "Enable email confirmations" setting applies globally.
            // If it's ON, new signups will require it.
            // If "Secure email change" is ON, email changes will require it.
            // For simplicity, we assume if `email_confirmed_at` is missing, it's required for new users.
            return !user.email_confirmed_at; // A basic check
        }


        async function loadCollections() { /* ... same as before ... */ 
            collectionsLoading.classList.remove('hidden');
            try {
                const { data: collections, error } = await supabaseClient
                    .from('collections')
                    .select('*')
                    .eq('user_id', appState.currentUser.id) 
                    .order('created_at', { ascending: false });

                if (error) throw error;
                appState.collections = collections || [];
                
                for (const collection of appState.collections) {
                    const { count } = await supabaseClient
                        .from('entries')
                        .select('*', { count: 'exact', head: true })
                        .eq('collection_id', collection.id);
                    collection.entryCount = count || 0;
                    
                    const { data: lastEntry } = await supabaseClient
                        .from('entries')
                        .select('date')
                        .eq('collection_id', collection.id)
                        .order('date', { ascending: false })
                        .limit(1)
                        .single();
                    collection.lastEntryDate = lastEntry?.date;
                }
            } catch (error) {
                console.error('Error loading collections:', error);
            } finally {
                collectionsLoading.classList.add('hidden');
            }
        }
        async function loadEntries(collectionId) { /* ... same as before ... */ 
            entriesLoading.classList.remove('hidden');
            try {
                const { data: entries, error } = await supabaseClient
                    .from('entries')
                    .select('*') 
                    .eq('collection_id', collectionId)
                    .order('date', { ascending: false }); 

                if (error) throw error;
                return entries || [];
            } catch (error) {
                console.error('Error loading entries:', error);
                return [];
            } finally {
                entriesLoading.classList.add('hidden');
            }
        }
        async function uploadImage(file, userId) { /* ... same as before ... */ 
             const fileExt = file.name.split('.').pop();
            const fileName = `${userId}/${Date.now()}-${Math.random().toString(36).substring(2, 9)}.${fileExt}`; // Added randomness
            
            const { data, error } = await supabaseClient.storage
                .from('entry-images')
                .upload(fileName, file, { contentType: file.type, upsert: false });

            if (error) { console.error('Upload error for file ' + file.name + ':', error); throw error; }
            
            const { data: { publicUrl } } = supabaseClient.storage
                .from('entry-images')
                .getPublicUrl(fileName);
            return publicUrl;
        }
        async function predictTagsForImage(imgDataURL) { /* ... same as before ... */ 
             if (!GOOGLE_CLOUD_VISION_API_KEY || GOOGLE_CLOUD_VISION_API_KEY === 'YOUR_GOOGLE_CLOUD_VISION_API_KEY_HERE') {
                console.warn("Google Cloud Vision API key not configured. Skipping tag prediction.");
                return [];
            }
            imageProcessingLoader.classList.remove('hidden');
            try {
                const base64Content = imgDataURL.split(',')[1];
                const response = await fetch(`https://vision.googleapis.com/v1/images:annotate?key=${GOOGLE_CLOUD_VISION_API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        requests: [{
                            image: { content: base64Content },
                            features: [
                                { type: 'LABEL_DETECTION', maxResults: 7 },
                                { type: 'OBJECT_LOCALIZATION', maxResults: 3 }
                            ]
                        }]
                    })
                });
                const result = await response.json();
                if (!response.ok || result.error || !result.responses || !result.responses[0]) {
                    console.error('Vision API error:', result.error || 'Invalid response');
                    return [];
                }
                const labels = result.responses[0].labelAnnotations || [];
                const objects = result.responses[0].localizedObjectAnnotations || [];
                const allPotentialTags = [...labels.map(l => l.description), ...objects.map(o => o.name)];
                const processedTags = allPotentialTags.map(tag => {
                    const lowercaseTag = tag.toLowerCase();
                    if (lowercaseTag.includes('dog') || lowercaseTag.includes('puppy')) return 'Dog';
                    if (lowercaseTag.includes('cat') || lowercaseTag.includes('kitten')) return 'Cat';
                    if (lowercaseTag.includes('flower') || lowercaseTag.includes('blossom')) return 'Flowering';
                    if (lowercaseTag.includes('plant') || lowercaseTag.includes('flora')) return 'Plant';
                    return tag.charAt(0).toUpperCase() + tag.slice(1).toLowerCase();
                });
                return [...new Set(processedTags)].filter(Boolean).slice(0, 5);
            } catch (e) {
                console.error("Prediction error:", e);
                return [];
            } finally {
                imageProcessingLoader.classList.add('hidden');
            }
        }
        function renderHomeView() {
            if (!appState.currentUser) { navigateTo('signup'); return; }
            greetingEl.textContent = `Welcome!`; 
            collectionsContainer.innerHTML = '';
            noCollectionsMessage.classList.toggle('hidden', appState.collections.length > 0);
            appState.collections.forEach(col => {
                const card = document.createElement('div');
                card.className = 'card collection-card';
                card.dataset.id = col.id;
                card.innerHTML = `
                    <h3>${col.name}</h3>
                    <p>${col.entryCount || 0} entries. ${col.lastEntryDate ? `Last: ${formatDate(col.lastEntryDate)}` : 'No entries yet'}</p>
                `;
                card.onclick = () => {
                    appState.activeCollectionId = col.id;
                    renderCollectionTimelineView();
                };
                collectionsContainer.appendChild(card);
            });
        }
        async function renderCollectionTimelineView() { /* ... same as before, uses getSanitizedImageUrls ... */ 
            const collection = appState.collections.find(c => c.id === appState.activeCollectionId);
            if (!collection) { console.error("Collection not found"); navigateTo('home'); return; }
            collectionTitleTimeline.textContent = collection.name;
            entriesTimelineContainer.innerHTML = '';
            appState.activeEntries = await loadEntries(collection.id); 
            noEntriesMessage.classList.toggle('hidden', appState.activeEntries.length > 0);
            
            appState.activeEntries.forEach((entry, idx) => {
                const tile = document.createElement('div');
                tile.className = 'card grid-entry-tile'; 
                tile.dataset.id = entry.id;
                
                let badgeHTML = '';
                if (idx < appState.activeEntries.length - 1) {
                    const currentDate = new Date(entry.date); 
                    const olderEntryDate = new Date(appState.activeEntries[idx + 1].date); 
                    
                    if (currentDate.getTime() > olderEntryDate.getTime()) {
                        const daysDiff = daysBetween(entry.date, appState.activeEntries[idx + 1].date);
                        if (daysDiff > 0) {
                            badgeHTML = `<span class="days-since-badge">${daysDiff} day${daysDiff > 1 ? 's' : ''} later</span>`;
                        }
                    } else if (currentDate.getTime() === olderEntryDate.getTime()) { 
                        badgeHTML = `<span class="days-since-badge">Same day</span>`;
                    }
                }
                const entryImageUrls = getSanitizedImageUrls(entry);
                const firstImageUrl = entryImageUrls.length > 0 ? entryImageUrls[0] : '';
                
                tile.innerHTML = `
                    <img src="${firstImageUrl}" alt="${entry.title}" class="grid-entry-image" ${!firstImageUrl ? 'style="background-color: #eee;"' : ''}>
                    <div class="grid-entry-info">
                        ${badgeHTML}
                        <h3 class="grid-entry-title">${entry.title}</h3>
                    </div>`;
                tile.onclick = () => {
                    appState.activeEntryId = entry.id;
                    renderEntryDetailView(entry); 
                    navigateTo('entryDetail');
                };
                entriesTimelineContainer.appendChild(tile); 
            });
            navigateTo('collectionTimeline');
        }
        function _renderTagBar(barElement, inputId, selectedTags, suggestedTags, addCustomFn, removeSelectedFn, selectSuggestedFn) { /* ... same as before ... */ 
            const customInputEl = barElement.querySelector(`#${inputId}`);
            const customVal = customInputEl ? customInputEl.value : '';
            barElement.innerHTML = '';

            selectedTags.forEach(tag => {
                const chip = document.createElement('span');
                chip.className = 'suggested-tag selected';
                chip.textContent = tag;
                chip.dataset.tag = tag;
                chip.onclick = () => removeSelectedFn(tag);
                barElement.appendChild(chip);
            });

            suggestedTags.forEach(tag => {
                if (!selectedTags.includes(tag)) { 
                    const chip = document.createElement('span');
                    chip.className = 'suggested-tag';
                    chip.textContent = tag;
                    chip.dataset.tag = tag;
                    chip.onclick = () => selectSuggestedFn(tag);
                    barElement.appendChild(chip);
                }
            });
            
            const newCustomInput = document.createElement('input');
            newCustomInput.type = 'text';
            newCustomInput.id = inputId;
            newCustomInput.placeholder = 'Add custom tag...';
            newCustomInput.value = customVal;
            barElement.appendChild(newCustomInput);
        }
        function handleAddCustomTagForNewEntry() { /* ... same as before ... */ 
             const input = tagBar.querySelector('#custom-tag-input');
            const tag = input.value.trim();
            if (tag && !appState.currentTags.includes(tag)) {
                appState.currentTags.push(tag);
                appState.aiSuggestedTags = appState.aiSuggestedTags.filter(st => st !== tag);
            }
            input.value = '';
            _renderTagBar(tagBar, 'custom-tag-input', appState.currentTags, appState.aiSuggestedTags, handleAddCustomTagForNewEntry, handleRemoveSelectedTagForNewEntry, handleSelectSuggestedTagForNewEntry);
        }
        function handleRemoveSelectedTagForNewEntry(tagToRemove) { /* ... same as before ... */ 
            appState.currentTags = appState.currentTags.filter(t => t !== tagToRemove);
            _renderTagBar(tagBar, 'custom-tag-input', appState.currentTags, appState.aiSuggestedTags, handleAddCustomTagForNewEntry, handleRemoveSelectedTagForNewEntry, handleSelectSuggestedTagForNewEntry);
        }
        function handleSelectSuggestedTagForNewEntry(tagToSelect) { /* ... same as before ... */ 
            if (!appState.currentTags.includes(tagToSelect)) {
                appState.currentTags.push(tagToSelect);
            }
            appState.aiSuggestedTags = appState.aiSuggestedTags.filter(t => t !== tagToSelect);
            _renderTagBar(tagBar, 'custom-tag-input', appState.currentTags, appState.aiSuggestedTags, handleAddCustomTagForNewEntry, handleRemoveSelectedTagForNewEntry, handleSelectSuggestedTagForNewEntry);
        }
        function handleAddCustomTagForEditEntry() { /* ... same as before ... */ 
            const input = editTagBarEl.querySelector('#edit-custom-tag-input');
            const tag = input.value.trim();
            if (tag && !appState.currentTags.includes(tag)) {
                appState.currentTags.push(tag);
            }
            input.value = '';
            _renderTagBar(editTagBarEl, 'edit-custom-tag-input', appState.currentTags, [], handleAddCustomTagForEditEntry, handleRemoveSelectedTagForEditEntry, () => {});
        }
        function handleRemoveSelectedTagForEditEntry(tagToRemove) { /* ... same as before ... */ 
             appState.currentTags = appState.currentTags.filter(t => t !== tagToRemove);
            _renderTagBar(editTagBarEl, 'edit-custom-tag-input', appState.currentTags, [], handleAddCustomTagForEditEntry, handleRemoveSelectedTagForEditEntry, () => {});
        }
        function renderNewEntryForm() { /* ... same as before ... */ 
            newEntryForm.reset();
            imagePreviewsContainer.innerHTML = ''; 
            imageUploadLabel.classList.remove('hidden');
            datePromptMessage.classList.add('hidden');
            entryDateInput.value = formatDate(new Date());
            
            appState.newEntrySelectedFiles = []; 
            appState.currentTags = []; 
            appState.aiSuggestedTags = []; 
            _renderTagBar(tagBar, 'custom-tag-input', appState.currentTags, appState.aiSuggestedTags, handleAddCustomTagForNewEntry, handleRemoveSelectedTagForNewEntry, handleSelectSuggestedTagForNewEntry);
            
            imageProcessingLoader.classList.add('hidden');
            entryUploadLoader.classList.add('hidden');
        }
        function renderNewEntryImagePreviews() { /* ... same as before ... */ 
            imagePreviewsContainer.innerHTML = ''; 
            if (appState.newEntrySelectedFiles.length > 0) {
                imageUploadLabel.classList.add('hidden');
            } else {
                imageUploadLabel.classList.remove('hidden');
            }

            appState.newEntrySelectedFiles.forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const previewItem = document.createElement('div');
                    previewItem.className = 'image-preview-item';
                    previewItem.innerHTML = `
                        <img src="${e.target.result}" alt="Preview ${index + 1}">
                        <button type="button" class="remove-preview-btn" data-index="${index}" title="Remove image">Ã—</button>
                    `;
                    previewItem.querySelector('.remove-preview-btn').onclick = () => {
                        appState.newEntrySelectedFiles.splice(index, 1);
                        renderNewEntryImagePreviews(); 
                        if(appState.newEntrySelectedFiles.length === 0) {
                             appState.aiSuggestedTags = [];
                             _renderTagBar(tagBar, 'custom-tag-input', appState.currentTags, appState.aiSuggestedTags, handleAddCustomTagForNewEntry, handleRemoveSelectedTagForNewEntry, handleSelectSuggestedTagForNewEntry);
                        } else if (index === 0) { 
                            processFirstImageForNewEntry();
                        }
                    };
                    imagePreviewsContainer.appendChild(previewItem);
                };
                reader.readAsDataURL(file);
            });
        }
        async function processFirstImageForNewEntry() { /* ... same as before ... */ 
            if (appState.newEntrySelectedFiles.length > 0) {
                const firstFile = appState.newEntrySelectedFiles[0];
                const reader = new FileReader();
                reader.onload = async (event) => {
                    const firstImageDataURL = event.target.result;
                    EXIF.getData(firstFile, function() {
                        let exifDateFound = false;
                        const dto = EXIF.getTag(this, "DateTimeOriginal");
                        if (dto) {
                            try {
                                const [datePart] = dto.split(' ');
                                const [year, month, day] = datePart.split(':');
                                if (year && month && day && !isNaN(new Date(`${year}-${month}-${day}`))) {
                                    entryDateInput.value = `${year}-${month}-${day}`;
                                    exifDateFound = true;
                                }
                            } catch (ex) { console.warn("EXIF parse error:", ex); }
                        }
                        datePromptMessage.classList.toggle('hidden', exifDateFound);
                        if (!exifDateFound) datePromptMessage.textContent = 'No date in first image. Set manually or use today.';
                    });
                    const predictedTags = await predictTagsForImage(firstImageDataURL);
                    appState.aiSuggestedTags = predictedTags.filter(pt => !appState.currentTags.includes(pt));
                    _renderTagBar(tagBar, 'custom-tag-input', appState.currentTags, appState.aiSuggestedTags, handleAddCustomTagForNewEntry, handleRemoveSelectedTagForNewEntry, handleSelectSuggestedTagForNewEntry);
                };
                reader.readAsDataURL(firstFile);
            } else {
                 datePromptMessage.classList.add('hidden');
                 appState.aiSuggestedTags = [];
                 _renderTagBar(tagBar, 'custom-tag-input', appState.currentTags, appState.aiSuggestedTags, handleAddCustomTagForNewEntry, handleRemoveSelectedTagForNewEntry, handleSelectSuggestedTagForNewEntry);
            }
        }
        function renderEditEntryForm(entry) { /* ... same as before, uses getSanitizedImageUrls ... */ 
            appState.editingEntryOriginal = JSON.parse(JSON.stringify(entry)); 
            const existingUrls = getSanitizedImageUrls(entry);
            appState.editEntryExistingImageUrls = [...existingUrls];
            appState.editEntryFilesToAdd = [];

            editExistingImagesContainer.innerHTML = '';
            editNewImagePreviewsContainer.innerHTML = '';

            appState.editEntryExistingImageUrls.forEach((url, index) => {
                const previewItem = document.createElement('div');
                previewItem.className = 'image-preview-item'; 
                previewItem.innerHTML = `
                    <img src="${url}" alt="Existing image ${index + 1}">
                    <button type="button" class="remove-preview-btn" data-url="${url}" title="Remove image">Ã—</button>
                `;
                previewItem.querySelector('.remove-preview-btn').onclick = () => {
                    appState.editEntryExistingImageUrls = appState.editEntryExistingImageUrls.filter(imgUrl => imgUrl !== url);
                    previewItem.remove(); 
                };
                editExistingImagesContainer.appendChild(previewItem);
            });
            
            document.getElementById('edit-entry-date').value = formatDate(entry.date);
            document.getElementById('edit-entry-title').value = entry.title;
            document.getElementById('edit-entry-notes').value = entry.notes || '';
            appState.currentTags = [...(entry.tags || [])]; 
            _renderTagBar(editTagBarEl, 'edit-custom-tag-input', appState.currentTags, [], handleAddCustomTagForEditEntry, handleRemoveSelectedTagForEditEntry, () => {});
            document.getElementById('edit-upload-loader').classList.add('hidden');
        }
        function renderEditEntryNewImagePreviews() { /* ... same as before ... */ 
            editNewImagePreviewsContainer.innerHTML = ''; 
            appState.editEntryFilesToAdd.forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const previewItem = document.createElement('div');
                    previewItem.className = 'image-preview-item';
                    previewItem.innerHTML = `
                        <img src="${e.target.result}" alt="New preview ${index + 1}">
                        <button type="button" class="remove-preview-btn" data-index="${index}" title="Remove new image">Ã—</button>
                    `;
                    previewItem.querySelector('.remove-preview-btn').onclick = () => {
                        appState.editEntryFilesToAdd.splice(index, 1);
                        renderEditEntryNewImagePreviews(); 
                    };
                    editNewImagePreviewsContainer.appendChild(previewItem);
                };
                reader.readAsDataURL(file);
            });
        }
        function renderEntryDetailView(entry) { /* ... same as before, uses getSanitizedImageUrls ... */ 
             const entryImageUrls = getSanitizedImageUrls(entry);

            if (!entry || entryImageUrls.length === 0) {
                detailImage.src = ''; 
                detailImage.alt = 'No image available';
                detailImage.style.cursor = 'default';
                detailImage.onclick = null;
                detailThumbnailsContainer.innerHTML = '';
            } else {
                appState.currentDetailImageIndex = 0; 
                displayDetailImage(entry, appState.currentDetailImageIndex);
            }

            detailTitle.textContent = entry.title;
            detailNotes.textContent = entry.notes || 'No notes.';
            detailMetadata.textContent = `Date: ${formatDate(entry.date)}`;
            
            detailTagsContainer.innerHTML = ''; 
            (entry.tags || []).forEach(tag => {
                const tagChip = document.createElement('span');
                tagChip.className = 'tag-chip clickable-tag';
                tagChip.textContent = tag;
                tagChip.dataset.tag = tag;
                tagChip.onclick = () => handleTagClick(tag);
                detailTagsContainer.appendChild(tagChip);
            });
            
            const idx = appState.activeEntries.findIndex(e => e.id === appState.activeEntryId);
            document.getElementById('prev-entry-btn').disabled = idx === 0;
            document.getElementById('next-entry-btn').disabled = idx === appState.activeEntries.length - 1;
            document.getElementById('prev-entry-btn').onclick = () => {
                if (idx > 0) { appState.activeEntryId = appState.activeEntries[idx - 1].id; renderEntryDetailView(appState.activeEntries[idx - 1]); }
            };
            document.getElementById('next-entry-btn').onclick = () => {
                if (idx < appState.activeEntries.length - 1) { appState.activeEntryId = appState.activeEntries[idx + 1].id; renderEntryDetailView(appState.activeEntries[idx + 1]); }
            };
        }
        function displayDetailImage(entry, index) { /* ... same as before, uses getSanitizedImageUrls ... */ 
            const entryImageUrls = getSanitizedImageUrls(entry);
            if (entryImageUrls.length === 0 || index < 0 || index >= entryImageUrls.length) {
                detailImage.src = ''; 
                detailImage.alt = 'No image available';
                detailImage.style.cursor = 'default';
                detailImage.onclick = null;
                detailThumbnailsContainer.innerHTML = '';
                return;
            }

            appState.currentDetailImageIndex = index;
            const currentImageUrl = entryImageUrls[index];
            detailImage.src = currentImageUrl;
            detailImage.alt = `${entry.title} - Image ${index + 1}`;
            detailImage.style.cursor = 'zoom-in';
            detailImage.onclick = () => openLightbox(currentImageUrl);

            detailThumbnailsContainer.innerHTML = '';
            entryImageUrls.forEach((url, i) => {
                const thumb = document.createElement('img');
                thumb.src = url;
                thumb.alt = `Thumbnail ${i + 1}`;
                thumb.className = 'detail-thumbnail';
                if (i === index) {
                    thumb.classList.add('active-thumb');
                }
                thumb.onclick = () => displayDetailImage(entry, i);
                detailThumbnailsContainer.appendChild(thumb);
            });
        }
        async function handleTagClick(tagName) { /* ... same as before ... */ 
            appState.currentTagName = tagName;
            appState.viewBeforeTagSearch = appState.currentView; 
            appState.entryIdBeforeTagSearch = appState.activeEntryId;
            appState.collectionIdForEntryBeforeTagSearch = appState.activeCollectionId;

            document.getElementById('tagged-entries-loading').classList.remove('hidden');
            document.getElementById('tagged-entries-container').innerHTML = ''; 
            document.getElementById('no-tagged-entries-message').classList.add('hidden');
            navigateTo('taggedEntries'); 

            const entries = await fetchEntriesByTag(tagName);
            appState.taggedEntries = entries; 
            renderTaggedEntriesView(tagName, entries);
            document.getElementById('tagged-entries-loading').classList.add('hidden');
        }
        async function fetchEntriesByTag(tagName) { /* ... same as before ... */ 
            try {
                const { data: userCollectionObjects, error: collectionError } = await supabaseClient
                    .from('collections')
                    .select('id')
                    .eq('user_id', appState.currentUser.id);

                if (collectionError) throw collectionError;
                if (!userCollectionObjects || userCollectionObjects.length === 0) return []; 

                const userCollectionIds = userCollectionObjects.map(c => c.id);
                
                const { data: entries, error: entriesError } = await supabaseClient
                    .from('entries')
                    .select('*') 
                    .in('collection_id', userCollectionIds) 
                    .contains('tags', [tagName])        
                    .order('date', { ascending: false }); 

                if (entriesError) throw entriesError;
                return entries || [];
            } catch (error) {
                console.error(`Error in fetchEntriesByTag for tag "${tagName}":`, error);
                const noTaggedMsg = document.getElementById('no-tagged-entries-message');
                noTaggedMsg.textContent = `Error loading entries. Please check console.`;
                noTaggedMsg.classList.remove('hidden');
                return [];
            }
        }
        function renderTaggedEntriesView(tagName, entries) { /* ... same as before, uses getSanitizedImageUrls ... */ 
            document.getElementById('tagged-entries-title').textContent = `Entries tagged: "${tagName}"`;
            const container = document.getElementById('tagged-entries-container');
            container.innerHTML = ''; 

            const noTaggedMsg = document.getElementById('no-tagged-entries-message');
            noTaggedMsg.classList.toggle('hidden', entries.length > 0);
            if (entries.length === 0 && !noTaggedMsg.textContent.startsWith("Error")) { 
                 noTaggedMsg.textContent = 'No entries found with this tag.';
            }

            entries.forEach((entry, idx) => { 
                const tile = document.createElement('div');
                tile.className = 'card grid-entry-tile'; 
                tile.dataset.id = entry.id;
                
                let badgeHTML = '';
                if (idx < entries.length - 1) {
                    const currentDate = new Date(entry.date);
                    const olderEntryDate = new Date(entries[idx + 1].date);

                    if (currentDate.getTime() > olderEntryDate.getTime()) {
                        const daysDiff = daysBetween(entry.date, entries[idx + 1].date);
                        if (daysDiff > 0) {
                            badgeHTML = `<span class="days-since-badge">${daysDiff} day${daysDiff > 1 ? 's' : ''} later</span>`;
                        }
                    } else if (currentDate.getTime() === olderEntryDate.getTime()) {
                        badgeHTML = `<span class="days-since-badge">Same day</span>`;
                    }
                }
                const entryImageUrls = getSanitizedImageUrls(entry);
                const firstImageUrl = entryImageUrls.length > 0 ? entryImageUrls[0] : '';
                
                tile.innerHTML = `
                    <img src="${firstImageUrl}" alt="${entry.title}" class="grid-entry-image" ${!firstImageUrl ? 'style="background-color: #eee;"' : ''}>
                    <div class="grid-entry-info">
                        ${badgeHTML}
                        <h3 class="grid-entry-title">${entry.title}</h3>
                    </div>`;
                tile.onclick = async () => {
                    appState.activeEntryId = entry.id;
                    appState.activeCollectionId = entry.collection_id; 
                    appState.activeEntries = await loadEntries(entry.collection_id); 
                    const fullEntryData = appState.activeEntries.find(e => e.id === entry.id) || entry; 
                    renderEntryDetailView(fullEntryData); 
                    navigateTo('entryDetail');
                };
                container.appendChild(tile); 
            });
        }
        function applyLightboxZoom() { /* ... same as before ... */ 
            lightboxImage.style.transform = `scale(${currentLightboxZoomScale})`;
            if (currentLightboxZoomScale > 1) {
                lightboxContent.style.cursor = 'grab'; 
                lightboxContent.style.overflow = 'auto';
            } else {
                lightboxContent.style.cursor = 'default';
                lightboxContent.style.overflow = 'hidden';
            }
        }
        function openLightbox(imageUrl) { /* ... same as before ... */ 
             if (!imageUrl) return; 
            lightboxImage.src = imageUrl;
            currentLightboxZoomScale = 1;
            applyLightboxZoom(); 
            lightboxOverlay.classList.remove('hidden');
            document.body.style.overflow = 'hidden'; 
            document.addEventListener('keydown', handleLightboxEscKey);
        }
        function closeLightbox() { /* ... same as before ... */ 
            lightboxOverlay.classList.add('hidden');
            lightboxImage.src = '#'; 
            document.body.style.overflow = ''; 
            document.removeEventListener('keydown', handleLightboxEscKey);
            lightboxContent.style.cursor = 'default';
            lightboxContent.scrollTop = 0;
            lightboxContent.scrollLeft = 0;
        }
        function handleLightboxEscKey(event) { if (event.key === 'Escape') closeLightbox(); }
        function zoomInLightbox() { /* ... same as before ... */ 
            if (currentLightboxZoomScale < LIGHTBOX_MAX_ZOOM) {
                currentLightboxZoomScale += LIGHTBOX_ZOOM_STEP;
                if (currentLightboxZoomScale > LIGHTBOX_MAX_ZOOM) currentLightboxZoomScale = LIGHTBOX_MAX_ZOOM;
            }
            applyLightboxZoom();
        }
        function zoomOutLightbox() { /* ... same as before ... */ 
            if (currentLightboxZoomScale > LIGHTBOX_MIN_ZOOM) {
                currentLightboxZoomScale -= LIGHTBOX_ZOOM_STEP;
                if (currentLightboxZoomScale < LIGHTBOX_MIN_ZOOM) currentLightboxZoomScale = LIGHTBOX_MIN_ZOOM;
            }
            applyLightboxZoom();
        }

        loginForm.onsubmit = async (e) => {
            e.preventDefault(); 
            loginError.classList.add('hidden'); loginError.textContent = '';
            loginInfo.classList.add('hidden'); loginInfo.textContent = '';
            const emailVal = document.getElementById('login-email').value;
            const passwordVal = document.getElementById('login-password').value;
            try {
                const { data, error } = await supabaseClient.auth.signInWithPassword({ 
                    email: emailVal, 
                    password: passwordVal 
                });
                if (error) {
                    // Check for specific error related to unconfirmed email
                    if (error.message.toLowerCase().includes('email not confirmed')) {
                        loginInfo.textContent = "Please check your email to verify your account before logging in.";
                        loginInfo.classList.remove('hidden');
                    } else {
                        throw error; // Rethrow other errors
                    }
                }
                // onAuthStateChange will handle successful login and navigation
            } catch (error) { 
                loginError.textContent = error.message; 
                loginError.classList.remove('hidden'); 
            }
        };

        signupForm.onsubmit = async (e) => {
            e.preventDefault(); 
            signupError.classList.add('hidden'); signupError.textContent = '';
            signupSuccess.classList.add('hidden'); signupSuccess.textContent = '';
            const usernameVal = document.getElementById('username').value;
            const phoneVal = document.getElementById('phone').value;
            const emailVal = document.getElementById('email').value;
            const passwordVal = document.getElementById('password').value;
            try {
                // If "Enable email confirmations" is ON in Supabase, `data.session` will be null here.
                // The user object will be returned but they are not yet authenticated.
                const { data: authResponse, error: authError } = await supabaseClient.auth.signUp({ 
                    email: emailVal, 
                    password: passwordVal,
                    options: {
                        data: { // This data is available in email templates via {{ .Data.username }}
                            username: usernameVal,
                            // phone: phoneVal // You can add phone here if needed in email template
                        }
                    }
                });

                if (authError) throw authError;

                if (authResponse.user) {
                    // Insert profile immediately, regardless of confirmation status
                    const { error: profileError } = await supabaseClient
                        .from('profiles')
                        .insert({ id: authResponse.user.id, username: usernameVal, phone: phoneVal });
                    if (profileError) {
                        // Log profile error but don't necessarily block the "check email" message
                        console.error('Profile creation error after signup:', profileError);
                    }

                    // Check if email confirmation is required by Supabase (it should be if enabled)
                    // `authResponse.session` will be null if confirmation is required
                    if (!authResponse.session && authResponse.user.identities && authResponse.user.identities.length > 0) {
                         signupSuccess.textContent = 'Account created! Please check your email to verify your account.';
                         signupSuccess.classList.remove('hidden');
                         signupForm.reset(); // Clear the form
                    } else if (authResponse.session) {
                        // This case means auto-confirmation might be on, or some other flow
                        // onAuthStateChange will handle it.
                        console.log("Signup successful with immediate session.");
                    } else {
                         // Fallback message if user object exists but no session and no clear indication of email sent
                         signupSuccess.textContent = 'Account created. Follow any instructions sent to your email.';
                         signupSuccess.classList.remove('hidden');
                    }
                } else {
                    // Should not happen if no error, but as a fallback
                    signupError.textContent = "Signup failed. Please try again.";
                    signupError.classList.remove('hidden');
                }
            } catch (error) { 
                signupError.textContent = error.message; 
                signupError.classList.remove('hidden'); 
            }
        };

        document.getElementById('sign-out-btn').onclick = async () => { /* ... same as before ... */ 
            if (confirm("Are you sure you want to sign out?")) {
                await supabaseClient.auth.signOut();
                // onAuthStateChange will handle navigation to login
            }
        };
        document.getElementById('new-collection-btn-home').onclick = () => { document.getElementById('collection-name').value = ''; navigateTo('newCollectionModal'); };
        document.getElementById('cancel-new-collection-btn').onclick = () => navigateTo('home');
        newCollectionForm.onsubmit = async (e) => { /* ... same as before ... */ 
             e.preventDefault();
            try {
                const { error } = await supabaseClient.from('collections').insert({ name: document.getElementById('collection-name').value, user_id: appState.currentUser.id }).select().single();
                if (error) throw error;
                await loadCollections(); renderHomeView(); navigateTo('home');
            } catch (error) { console.error('Error creating collection:', error); alert('Error creating collection.'); }
        };
        document.getElementById('back-to-home-btn').onclick = () => navigateTo('home');
        document.getElementById('add-entry-fab').onclick = () => { renderNewEntryForm(); navigateTo('newEntry'); };
        document.getElementById('back-to-timeline-btn').onclick = () => { appState.activeCollectionId ? renderCollectionTimelineView() : navigateTo('home'); };
        imageUploadInput.onchange = e => { /* ... same as before ... */ 
            appState.newEntrySelectedFiles = Array.from(e.target.files); 
            renderNewEntryImagePreviews();
            processFirstImageForNewEntry(); 
        };
        document.getElementById('add-custom-tag-btn').onclick = handleAddCustomTagForNewEntry;
        tagBar.addEventListener('keypress', e => { if (e.target.id === 'custom-tag-input' && e.key === 'Enter') { e.preventDefault(); handleAddCustomTagForNewEntry(); }});
        newEntryForm.onsubmit = async (e) => { /* ... same as before ... */ 
            e.preventDefault(); 
            if (appState.newEntrySelectedFiles.length === 0) { 
                alert("Please select at least one image."); return; 
            }
            entryUploadLoader.classList.remove('hidden'); 
            document.getElementById('create-entry-btn').disabled = true;
            
            try {
                const uploadedImageUrls = [];
                for (const file of appState.newEntrySelectedFiles) {
                    const url = await uploadImage(file, appState.currentUser.id); 
                    uploadedImageUrls.push(url);
                }

                const entryData = { 
                    collection_id: appState.activeCollectionId, 
                    title: document.getElementById('entry-title').value, 
                    notes: document.getElementById('entry-notes').value, 
                    date: entryDateInput.value, 
                    image_urls: uploadedImageUrls, 
                    tags: appState.currentTags.filter(Boolean) 
                };
                const { error } = await supabaseClient.from('entries').insert(entryData).select().single();
                if (error) throw error;
                
                appState.newEntrySelectedFiles = [];
                imagePreviewsContainer.innerHTML = '';
                imageUploadLabel.classList.remove('hidden');

                await renderCollectionTimelineView(); 
            } catch (error) { 
                console.error('Error in entry creation process:', error); 
                alert(`Error creating entry: ${error.message}`);
            } finally { 
                entryUploadLoader.classList.add('hidden'); 
                document.getElementById('create-entry-btn').disabled = false; 
            }
        };
        document.getElementById('back-to-timeline-from-detail-btn').onclick = () => { appState.activeCollectionId ? renderCollectionTimelineView() : navigateTo('home'); };
        document.getElementById('back-from-tagged-view-btn').onclick = async () => { /* ... same as before ... */ 
            if (appState.viewBeforeTagSearch === 'entryDetail' && appState.entryIdBeforeTagSearch && appState.collectionIdForEntryBeforeTagSearch) {
                appState.activeEntryId = appState.entryIdBeforeTagSearch;
                appState.activeCollectionId = appState.collectionIdForEntryBeforeTagSearch;
                appState.activeEntries = await loadEntries(appState.activeCollectionId); 
                const originalEntry = appState.activeEntries.find(e => e.id === appState.entryIdBeforeTagSearch);
                if (originalEntry) {
                    renderEntryDetailView(originalEntry);
                    navigateTo('entryDetail');
                } else {
                    navigateTo('home');
                }
            } else {
                 appState.activeCollectionId ? renderCollectionTimelineView() : navigateTo('home');
            }
        };
        document.getElementById('delete-collection-btn').onclick = async () => { /* ... same as before ... */ 
            const col = appState.collections.find(c => c.id === appState.activeCollectionId);
            if (!col || !confirm(`Delete collection "${col.name}" and ALL its entries? This cannot be undone.`)) return;
            try {
                const { error: entriesError } = await supabaseClient.from('entries').delete().eq('collection_id', appState.activeCollectionId);
                if (entriesError) throw entriesError;

                const { error } = await supabaseClient.from('collections').delete().eq('id', appState.activeCollectionId);
                if (error) throw error;
                
                appState.activeCollectionId = null; await loadCollections(); renderHomeView(); navigateTo('home');
            } catch (error) { console.error('Error deleting collection:', error); alert('Error deleting collection.'); }
        };
        document.getElementById('delete-entry-btn').onclick = async () => { /* ... same as before ... */ 
             if (!appState.activeEntryId || !confirm("Are you sure you want to delete this entry?")) return;
            try {
                const { error } = await supabaseClient.from('entries').delete().eq('id', appState.activeEntryId);
                if (error) throw error;
                appState.activeEntryId = null; await renderCollectionTimelineView();
            } catch (error) { console.error('Error deleting entry:', error); alert('Error deleting entry.'); }
        };
        document.getElementById('switch-to-signup').onclick = () => { 
            loginError.classList.add('hidden'); loginInfo.classList.add('hidden');
            navigateTo('signup'); 
        };
        document.getElementById('switch-to-login').onclick = () => {
            signupError.classList.add('hidden'); signupSuccess.classList.add('hidden');
            navigateTo('login'); 
        };
        document.getElementById('edit-entry-btn').onclick = () => { /* ... same as before ... */ 
             const entry = appState.activeEntries.find(e => e.id === appState.activeEntryId);
            if (entry) { renderEditEntryForm(entry); navigateTo('editEntry'); }
        };
        document.getElementById('back-to-detail-btn').onclick = () => { /* ... same as before ... */ 
            const entry = appState.activeEntries.find(e => e.id === appState.activeEntryId) || appState.editingEntryOriginal;
            if (entry) { renderEntryDetailView(entry); navigateTo('entryDetail'); } 
            else { renderCollectionTimelineView(); }
        };
        editAddMoreImagesInput.onchange = (e) => { /* ... same as before ... */ 
            appState.editEntryFilesToAdd = Array.from(e.target.files);
            renderEditEntryNewImagePreviews();
        };
        document.getElementById('edit-add-custom-tag-btn').onclick = handleAddCustomTagForEditEntry;
        editTagBarEl.addEventListener('keypress', e => { if (e.target.id === 'edit-custom-tag-input' && e.key === 'Enter') { e.preventDefault(); handleAddCustomTagForEditEntry(); }});
        editEntryForm.onsubmit = async (e) => { /* ... same as before ... */ 
            e.preventDefault();
            const editLoader = document.getElementById('edit-upload-loader'); 
            const saveBtn = document.getElementById('save-entry-btn');
            editLoader.classList.remove('hidden'); 
            saveBtn.disabled = true;

            try {
                const newUploadedImageUrls = [];
                for (const file of appState.editEntryFilesToAdd) {
                    const url = await uploadImage(file, appState.currentUser.id); 
                    newUploadedImageUrls.push(url);
                }

                const finalImageUrls = [...appState.editEntryExistingImageUrls, ...newUploadedImageUrls];

                const updatedEntryData = { 
                    title: document.getElementById('edit-entry-title').value, 
                    notes: document.getElementById('edit-entry-notes').value, 
                    date: document.getElementById('edit-entry-date').value, 
                    tags: appState.currentTags.filter(Boolean),
                    image_urls: finalImageUrls 
                };

                const { error } = await supabaseClient
                    .from('entries')
                    .update(updatedEntryData)
                    .eq('id', appState.activeEntryId);

                if (error) throw error;
                
                appState.activeEntries = await loadEntries(appState.activeCollectionId); 
                const updatedEntry = appState.activeEntries.find(entry => entry.id === appState.activeEntryId);

                if (updatedEntry) { 
                    renderEntryDetailView(updatedEntry); 
                    navigateTo('entryDetail'); 
                } else { 
                    renderCollectionTimelineView(); 
                }
            } catch (error) { 
                console.error('Error updating entry:', error); 
                alert('Error updating entry.');
            } finally { 
                editLoader.classList.add('hidden'); 
                saveBtn.disabled = false; 
                appState.editEntryFilesToAdd = [];
                // appState.editEntryExistingImageUrls = []; // No! This is reset when renderEditEntryForm is called.
                editNewImagePreviewsContainer.innerHTML = '';
            }
        };

        let touchstartX = 0, touchendX = 0;
        const entryDetailViewEl = views.entryDetail; // Ensure views.entryDetail is assigned
        if (entryDetailViewEl) { // Check if element exists before adding listeners
            function handleSwipe() {
                const swipeThreshold = 50; 
                if (touchendX < touchstartX - swipeThreshold) document.getElementById('next-entry-btn').click();
                if (touchendX > touchstartX + swipeThreshold) document.getElementById('prev-entry-btn').click();
            }
            entryDetailViewEl.addEventListener('touchstart', e => { touchstartX = e.changedTouches[0].screenX; }, {passive: true});
            entryDetailViewEl.addEventListener('touchend', e => { touchendX = e.changedTouches[0].screenX; handleSwipe(); }, {passive: true});
        } else {
            console.warn("#entry-detail-view not found for swipe listeners.");
        }


        // DOMContentLoaded is used to ensure onAuthStateChange is set up early,
        // but most of the UI logic (like initial navigation) will be handled by onAuthStateChange itself.
        document.addEventListener('DOMContentLoaded', () => { 
            console.log("DOM fully loaded and parsed. Supabase client initialized.");
            // onAuthStateChange will handle initial session and navigation.
            // No explicit navigateTo() here unless it's a fallback for no auth state.

            lightboxCloseBtn.addEventListener('click', closeLightbox);
            lightboxZoomInBtn.addEventListener('click', zoomInLightbox);
            lightboxZoomOutBtn.addEventListener('click', zoomOutLightbox);
            lightboxOverlay.addEventListener('click', (event) => {
                if (event.target === lightboxOverlay) {
                    closeLightbox();
                }
            });
        });
    </script>
</body>
</html>
